<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>èŠå¤©ç•Œé¢ - å¯çˆ±QQ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "PingFang SC", "å¾®è½¯é›…é»‘", sans-serif;
    }
    body {
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #f5f5f5;
    }
    /* æ‰‹æœºå®¹å™¨ */
    .phone-screen {
      width: 375px;
      height: 812px;
      border: 1px solid #eee;
      border-radius: 40px;
      overflow: hidden;
      position: relative;
      background: #fff;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    /* è¿”å›é”® */
    .back-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      width: 36px;
      height: 36px;
      background: #f8dce8;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(255,182,193,0.3);
      z-index: 999;
    }
    .back-btn::after {
      content: '';
      width: 14px;
      height: 14px;
      border-top: 2px solid #ffabb8;
      border-left: 2px solid #ffabb8;
      transform: rotate(-45deg);
    }
    /* èŠå¤©æ ‡é¢˜æ  */
    .chat-header {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 60px;
      background: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 990;
    }
    .chat-name {
      font-size: 16px;
      color: #333;
      font-weight: bold;
    }
    /* å³ä¸Šè§’ä¸‰æ¡æ ï¼ˆé»‘è‰²ï¼Œå¯è§ï¼‰ */
    .more-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 30px;
      height: 30px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      z-index: 995;
    }
    .more-btn span {
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: #000; /* æ”¹ä¸ºé»‘è‰² */
    }
    /* èŠå¤©èƒŒæ™¯ */
    .chat-bg {
      position: absolute;
      top: 60px;
      left: 0;
      width: 100%;
      height: calc(100% - 120px);
      background: #f0f8ff;
      z-index: 980;
    }
    .chat-bg img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0.3;
    }
    /* èŠå¤©å†…å®¹åŒº */
    .chat-container {
      position: absolute;
      top: 60px;
      left: 0;
      width: 100%;
      height: calc(100% - 120px);
      padding: 15px;
      overflow-y: auto;
      z-index: 985;
    }
    /* æ¶ˆæ¯å®¹å™¨ï¼šå¸¦å¤´åƒæ’ç‰ˆ */
    .msg-container {
      display: flex;
      margin-bottom: 15px;
    }
    /* ä»–äººæ¶ˆæ¯ï¼šå¤´åƒåœ¨å·¦ */
    .other-msg-container {
      align-items: flex-start;
    }
    /* è‡ªå·±æ¶ˆæ¯ï¼šå¤´åƒåœ¨å³ */
    .self-msg-container {
      flex-direction: row-reverse;
      align-items: flex-start;
    }
    /* æ¶ˆæ¯å¤´åƒ */
    .msg-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      overflow: hidden;
      margin: 0 8px;
      flex-shrink: 0;
    }
    .msg-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    /* æ¶ˆæ¯æ°”æ³¡æ ·å¼ï¼ˆçœŸå®QQè‰²+å¸¦å¤´åƒï¼‰ */
    .msg-bubble {
      max-width: 70%;
      padding: 10px;
      border-radius: 10px;
      font-size: 14px;
      line-height: 1.5;
      position: relative;
    }
    .other-msg {
      background: #fff;
      color: #333;
      border-bottom-left-radius: 3px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .self-msg {
      background: #0084ff;
      color: #fff;
      border-bottom-right-radius: 3px;
    }
    /* æ¶ˆæ¯æ—¶é—´ */
    .msg-time {
      font-size: 10px;
      margin-top: 5px;
      text-align: right;
      opacity: 0.7;
    }
    /* ç‰¹æ®Šæ¶ˆæ¯å¡ç‰‡ï¼ˆè½¬è´¦/çº¢åŒ…/éŸ³ä¹ï¼‰ */
    .special-msg-card {
      max-width: 70%;
      border-radius: 10px;
      overflow: hidden;
      background: #fff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 15px;
    }
    .transfer-card {
      border-left: 4px solid #0084ff; /* è“è‰²è½¬è´¦å¡ç‰‡ */
    }
    .redpacket-card {
      border-left: 4px solid #ff5252; /* çº¢è‰²çº¢åŒ…å¡ç‰‡ */
    }
    .music-card {
      border-left: 4px solid #2ecc71; /* ç»¿è‰²éŸ³ä¹å¡ç‰‡ */
    }
    .card-header {
      padding: 10px 15px;
      font-size: 14px;
      color: #333;
      border-bottom: 1px solid #f5f5f5;
    }
    .card-body {
      padding: 15px;
      font-size: 14px;
      color: #333;
    }
    .transfer-amount, .redpacket-amount {
      font-size: 20px;
      color: #0084ff;
      font-weight: bold;
      margin: 10px 0;
    }
    .music-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .music-cover {
      width: 40px;
      height: 40px;
      border-radius: 5px;
      background: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #666;
    }
    .music-text {
      flex: 1;
    }
    .music-name {
      font-size: 14px;
      color: #333;
    }
    .music-singer {
      font-size: 12px;
      color: #999;
    }
    .play-btn {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #0084ff;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 14px;
      cursor: pointer;
    }
    /* æ¶ˆæ¯é•¿æŒ‰èœå•ï¼ˆé€‚é…å®½åº¦ï¼‰ */
    .msg-menu {
      position: absolute;
      bottom: -40px;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 999;
      display: none;
      white-space: nowrap; /* è‡ªé€‚åº”æ–‡å­—å®½åº¦ */
    }
    .msg-menu-item {
      padding: 5px 10px;
      font-size: 12px;
      color: #333;
      cursor: pointer;
      display: inline-block;
    }
    .msg-menu-item:hover {
      background: #f5f5f5;
    }
    /* è¾“å…¥åŒºï¼šæ”¯æŒè¯­éŸ³åˆ‡æ¢ */
    .input-area {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 60px;
      background: #fff;
      display: flex;
      align-items: center;
      padding: 0 15px;
      z-index: 990;
    }
    .func-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #666;
      font-size: 20px;
      cursor: pointer;
      margin-right: 10px;
    }
    /* æ–‡å­—è¾“å…¥æ¡† */
    .chat-input {
      flex: 1;
      height: 36px;
      padding: 0 15px;
      border: 1px solid #f5f5f5;
      border-radius: 18px;
      outline: none;
      font-size: 14px;
    }
    /* è¯­éŸ³è¾“å…¥æ¡† */
    .voice-input {
      flex: 1;
      height: 36px;
      padding: 0 15px;
      border: 1px solid #0084ff;
      border-radius: 18px;
      background: #e8f4fd;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #0084ff;
      font-size: 14px;
    }
    .voice-tip {
      color: #0084ff;
      font-size: 14px;
    }
    .switch-text-btn {
      width: 60px;
      height: 36px;
      background: #f5f5f5;
      color: #666;
      border: none;
      border-radius: 18px;
      margin-left: 10px;
      cursor: pointer;
      font-size: 14px;
    }
    .send-btn {
      width: 60px;
      height: 36px;
      background: #0084ff;
      color: #fff;
      border: none;
      border-radius: 18px;
      margin-left: 10px;
      cursor: pointer;
      font-size: 14px;
    }
    /* åŠŸèƒ½å¼¹çª— */
    .func-modal {
      position: absolute;
      bottom: 70px;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      padding: 15px;
      z-index: 1000;
      display: none;
    }
    .func-modal.active {
      display: block;
    }
    .func-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
    }
    .func-item {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 5px;
      font-size: 12px;
      color: #666;
      cursor: pointer;
    }
    .func-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 20px;
      color: #0084ff;
    }
    /* è¡¨æƒ…åŒ…å¼¹çª— */
    .emoji-modal {
      position: absolute;
      bottom: 70px;
      left: 0;
      width: 100%;
      height: 200px;
      background: #fff;
      border-top-left-radius: 15px;
      border-top-right-radius: 15px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      padding: 15px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }
    .emoji-modal.active {
      display: block;
    }
    .emoji-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .emoji-title {
      font-size: 14px;
      color: #333;
      font-weight: bold;
    }
    .add-emoji-btn {
      padding: 5px 10px;
      background: #0084ff;
      color: #fff;
      border: none;
      border-radius: 5px;
      font-size: 12px;
      cursor: pointer;
    }
    .emoji-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 10px;
    }
    .emoji-item {
      width: 30px;
      height: 30px;
      cursor: pointer;
      text-align: center;
    }
    .emoji-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 5px;
    }
    .empty-emoji {
      width: 100%;
      height: 150px;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #999;
      font-size: 14px;
    }
    /* éŸ³ä¹é€‰æ‹©å¼¹çª— */
    .music-modal {
      position: absolute;
      bottom: 70px;
      left: 0;
      width: 100%;
      height: 200px;
      background: #fff;
      border-top-left-radius: 15px;
      border-top-right-radius: 15px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      padding: 15px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }
    .music-modal.active {
      display: block;
    }
    .music-title {
      font-size: 14px;
      color: #333;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .music-item {
      padding: 8px 0;
      border-bottom: 1px solid #f5f5f5;
      font-size: 14px;
      color: #333;
      cursor: pointer;
    }
    .music-item:hover {
      background: #f5f5f5;
    }
    /* è½¬è´¦/çº¢åŒ…å¼¹çª—ï¼ˆè“è‰²é£æ ¼ï¼‰ */
    .transfer-modal, .redpacket-modal {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      padding: 20px;
      z-index: 1000;
      display: none;
    }
    .transfer-modal.active, .redpacket-modal.active {
      display: block;
    }
    .modal-header {
      font-size: 16px;
      color: #333;
      font-weight: bold;
      margin-bottom: 15px;
      text-align: center;
    }
    .transfer-modal .modal-header {
      color: #0084ff; /* è½¬è´¦æ ‡é¢˜è“è‰² */
    }
    .redpacket-modal .modal-header {
      color: #ff5252; /* çº¢åŒ…æ ‡é¢˜çº¢è‰² */
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-label {
      display: block;
      font-size: 14px;
      color: #666;
      margin-bottom: 5px;
    }
    .amount-input, .remark-input {
      width: 100%;
      padding: 10px;
      border: 1px solid #f5f5f5;
      border-radius: 8px;
      font-size: 16px;
      outline: none;
    }
    .amount-input {
      text-align: center;
      color: #0084ff;
      font-weight: bold;
    }
    .confirm-btn {
      width: 100%;
      padding: 12px;
      background: #0084ff; /* è½¬è´¦ç¡®è®¤æŒ‰é’®è“è‰² */
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }
    .redpacket-modal .confirm-btn {
      background: #ff5252; /* çº¢åŒ…ç¡®è®¤æŒ‰é’®çº¢è‰² */
    }
    .cancel-btn {
      width: 100%;
      padding: 12px;
      background: #f5f5f5;
      color: #666;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 10px;
    }
    /* è”ç³»äººè®¾ç½®é¡µé¢ï¼ˆæ–°å¢æ‹‰é»‘æŒ‰é’®ï¼‰ */
    .contact-setting-page {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #fff;
      z-index: 1000;
      display: none;
      padding: 20px;
      overflow-y: auto;
    }
    .contact-setting-page.active {
      display: block;
    }
    .setting-header {
      font-size: 18px;
      color: #333;
      font-weight: bold;
      margin-bottom: 20px;
      text-align: center;
    }
    .setting-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: #eee;
      overflow: hidden;
      margin: 0 auto 15px;
    }
    .setting-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .setting-item {
      margin-bottom: 15px;
    }
    .setting-label {
      font-size: 14px;
      color: #999;
      margin-bottom: 5px;
    }
    .setting-input {
      width: 100%;
      padding: 10px;
      border: 1px solid #f5f5f5;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
    }
    .setting-select {
      width: 100%;
      padding: 10px;
      border: 1px solid #f5f5f5;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      background: #fff;
    }
    .delete-btn {
      width: 100%;
      padding: 12px;
      background: #ff4d4f;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 20px;
    }
    /* æ‹‰é»‘æŒ‰é’®æ ·å¼ */
    .block-btn {
      width: 100%;
      padding: 12px;
      background: #ff5252;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 10px;
    }
    .unblock-btn {
      background: #4CAF50;
    }
    /* æ‹‰é»‘æç¤º */
    .block-tip {
      padding: 8px;
      background: #ffebee;
      color: #ff5252;
      border-radius: 5px;
      font-size: 12px;
      text-align: center;
      margin-top: 5px;
      display: none;
    }
    .block-tip.active {
      display: block;
    }
    /* éšè—åŸç”Ÿæ–‡ä»¶é€‰æ‹©å™¨ */
    #emoji-upload, #setting-avatar-upload, #setting-bg-upload {
      display: none;
    }
  </style>
</head>
<body>
  <div class="phone-screen">
    <!-- è¿”å›é”® -->
    <div class="back-btn" onclick="backToContactDetail()"></div>
    <!-- èŠå¤©æ ‡é¢˜æ  -->
    <div class="chat-header">
      <div class="chat-name" id="chatName">è”ç³»äººåç§°</div>
    </div>
    <!-- å³ä¸Šè§’ä¸‰æ¡æ ï¼ˆé»‘è‰²ï¼‰ -->
    <div class="more-btn" onclick="toggleContactSetting()"></div>
    <!-- èŠå¤©èƒŒæ™¯ -->
    <div class="chat-bg" id="chatBg">
      <img src="app.img/default-bg.jpg" alt="èŠå¤©èƒŒæ™¯">
    </div>
    <!-- èŠå¤©å†…å®¹åŒº -->
    <div class="chat-container" id="chatContainer">
      <div style="text-align:center; color:#999; font-size:12px; margin-top:50%;">
        å¼€å§‹èŠå¤©å§ï½
      </div>
    </div>
    <!-- è¾“å…¥åŒºï¼ˆæ”¯æŒæ–‡å­—/è¯­éŸ³åˆ‡æ¢ï¼‰ -->
    <div class="input-area">
      <div class="func-btn" onclick="toggleFuncModal()">+</div>
      <!-- æ–‡å­—è¾“å…¥æ¡†ï¼ˆé»˜è®¤æ˜¾ç¤ºï¼‰ -->
      <input type="text" class="chat-input" id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯...">
      <!-- è¯­éŸ³è¾“å…¥æ¡†ï¼ˆé»˜è®¤éšè—ï¼‰ -->
      <div class="voice-input" id="voiceInput" style="display:none;" onmousedown="startRecord()" onmouseup="stopRecord()" onmouseleave="stopRecord()">
        <span class="voice-tip">é•¿æŒ‰å½•éŸ³</span>
      </div>
      <!-- è¯­éŸ³/æ–‡å­—åˆ‡æ¢æŒ‰é’®ï¼ˆé»˜è®¤éšè—ï¼‰ -->
      <button class="switch-text-btn" id="switchTextBtn" style="display:none;" onclick="switchToTextInput()">æ–‡å­—</button>
      <button class="send-btn" id="sendBtn" onclick="sendMsg()">å‘é€</button>
      <!-- è¯­éŸ³æŒ‰é’®ï¼ˆé»˜è®¤æ˜¾ç¤ºï¼‰ -->
      <button class="send-btn" id="voiceBtn" onclick="switchToVoiceInput()">è¯­éŸ³</button>
    </div>
    <!-- 1. åŠŸèƒ½å¼¹çª— -->
    <div class="func-modal" id="funcModal">
      <div class="func-grid">
        <div class="func-item" onclick="toggleEmojiModal()">
          <div class="func-icon">ğŸ˜€</div>
          <div>è¡¨æƒ…åŒ…</div>
        </div>
        <div class="func-item" onclick="toggleTransferModal()">
          <div class="func-icon">ğŸ’¸</div>
          <div>è½¬è´¦</div>
        </div>
        <div class="func-item" onclick="toggleRedpacketModal()">
          <div class="func-icon">ğŸ§§</div>
          <div>çº¢åŒ…</div>
        </div>
        <div class="func-item" onclick="switchToVoiceInput()">
          <div class="func-icon">ğŸ¤</div>
          <div>è¯­éŸ³</div>
        </div>
        <div class="func-item" onclick="toggleMusicModal()">
          <div class="func-icon">ğŸµ</div>
          <div>åˆ†äº«éŸ³ä¹</div>
        </div>
      </div>
    </div>
    <!-- 2. è¡¨æƒ…åŒ…å¼¹çª— -->
    <div class="emoji-modal" id="emojiModal">
      <div class="emoji-header">
        <div class="emoji-title">è¡¨æƒ…åŒ…</div>
        <button class="add-emoji-btn" onclick="document.getElementById('emoji-upload').click()">æ·»åŠ è¡¨æƒ…åŒ…</button>
        <input type="file" id="emoji-upload" accept="image/*" onchange="addEmoji(this)">
      </div>
      <div class="emoji-grid" id="emojiGrid">
        <div class="empty-emoji" id="emptyEmojiTip">æš‚æ— è¡¨æƒ…åŒ…ï¼Œç‚¹å‡»æ·»åŠ ï½</div>
      </div>
    </div>
    <!-- 3. éŸ³ä¹é€‰æ‹©å¼¹çª— -->
    <div class="music-modal" id="musicModal">
      <div class="music-title">é€‰æ‹©éŸ³ä¹</div>
      <div id="musicList" class="music-list">
        <!-- åŠ¨æ€æ¸²æŸ“éŸ³ä¹åˆ—è¡¨ -->
      </div>
    </div>
    <!-- 4. è½¬è´¦å¼¹çª—ï¼ˆè“è‰²é£æ ¼ï¼‰ -->
    <div class="transfer-modal" id="transferModal">
      <div class="modal-header">è½¬è´¦ç»™ ${document.getElementById('chatName').textContent || 'è”ç³»äºº'}</div>
      <div class="form-group">
        <label class="form-label">é‡‘é¢ï¼ˆå…ƒï¼‰</label>
        <input type="number" class="amount-input" id="transferAmount" placeholder="0.00" min="0.01" step="0.01" required>
      </div>
      <div class="form-group">
        <label class="form-label">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
        <input type="text" class="remark-input" id="transferRemark" placeholder="è¾“å…¥å¤‡æ³¨">
      </div>
      <button class="confirm-btn" onclick="confirmTransfer()">ç¡®è®¤è½¬è´¦</button>
      <button class="cancel-btn" onclick="toggleTransferModal()">å–æ¶ˆ</button>
    </div>
    <!-- 5. çº¢åŒ…å¼¹çª— -->
    <div class="redpacket-modal" id="redpacketModal">
      <div class="modal-header">å‘çº¢åŒ…ç»™ ${document.getElementById('chatName').textContent || 'è”ç³»äºº'}</div>
      <div class="form-group">
        <label class="form-label">é‡‘é¢ï¼ˆå…ƒï¼‰</label>
        <input type="number" class="amount-input" id="redpacketAmount" placeholder="0.00" min="0.01" step="0.01" required>
      </div>
      <div class="form-group">
        <label class="form-label">ç•™è¨€ï¼ˆå¯é€‰ï¼‰</label>
        <input type="text" class="remark-input" id="redpacketRemark" placeholder="æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©">
      </div>
      <button class="confirm-btn" onclick="confirmRedpacket()">ç¡®è®¤å‘é€</button>
      <button class="cancel-btn" onclick="toggleRedpacketModal()">å–æ¶ˆ</button>
    </div>
    <!-- 6. æ¶ˆæ¯é•¿æŒ‰èœå• -->
    <div class="msg-menu" id="msgMenu">
      <div class="msg-menu-item" onclick="traceMsg()">å›æº¯</div>
      <div class="msg-menu-item" onclick="editMsg()">ç¼–è¾‘</div>
      <div class="msg-menu-item" onclick="deleteMsg()">åˆ é™¤</div>
    </div>
    <!-- 7. è”ç³»äººè®¾ç½®é¡µé¢ï¼ˆæ–°å¢æ‹‰é»‘æŒ‰é’®ï¼‰ -->
    <div class="contact-setting-page" id="contactSettingPage">
      <div class="setting-header">è”ç³»äººè®¾ç½®</div>
      <!-- å¤´åƒè®¾ç½® -->
      <div class="setting-item">
        <div class="setting-label">å¤´åƒ</div>
        <div class="setting-avatar" onclick="document.getElementById('setting-avatar-upload').click()">
          <img id="settingAvatarImg" src="app.img/default-contact.png" alt="è”ç³»äººå¤´åƒ">
        </div>
        <input type="file" id="setting-avatar-upload" accept="image/*" onchange="updateSettingAvatar(this)">
      </div>
      <!-- åç§°è®¾ç½® -->
      <div class="setting-item">
        <div class="setting-label">åç§°</div>
        <input type="text" class="setting-input" id="settingName" placeholder="è¾“å…¥è”ç³»äººåç§°">
      </div>
      <!-- èƒŒæ™¯è®¾ç½® -->
      <div class="setting-item">
        <div class="setting-label">èŠå¤©èƒŒæ™¯</div>
        <div class="setting-avatar" style="width: 100px; height: 50px; border-radius: 8px;" onclick="document.getElementById('setting-bg-upload').click()">
          <img id="settingBgImg" src="app.img/default-bg.jpg" alt="èŠå¤©èƒŒæ™¯">
        </div>
        <input type="file" id="setting-bg-upload" accept="image/*" onchange="updateSettingBg(this)">
      </div>
      <!-- äººè®¾è®¾ç½® -->
      <div class="setting-item">
        <div class="setting-label">äººè®¾</div>
        <input type="text" class="setting-input" id="settingPersona" placeholder="è¾“å…¥è”ç³»äººè§’è‰²è®¾å®š">
      </div>
      <!-- APIé€‰æ‹© -->
      <div class="setting-item">
        <div class="setting-label">APIé€‰æ‹©</div>
        <select class="setting-select" id="settingApiSelect">
          <option value="-1">è¯·é€‰æ‹©API</option>
        </select>
      </div>
      <!-- æ‹‰é»‘æŒ‰é’® -->
      <button class="block-btn" id="blockBtn" onclick="toggleBlockContact()">æ‹‰é»‘è¯¥è”ç³»äºº</button>
      <!-- æ“ä½œæŒ‰é’® -->
      <button class="delete-btn" onclick="deleteAllChatLogs()">åˆ é™¤æ‰€æœ‰èŠå¤©è®°å½•</button>
      <button class="delete-btn" onclick="deleteContact()" style="margin-top: 10px;">åˆ é™¤è”ç³»äºº</button>
      <button class="cancel-btn" onclick="toggleContactSetting()">ä¿å­˜å¹¶è¿”å›</button>
    </div>
  </div>
  <script>
    // æœ¬åœ°å­˜å‚¨Key
    const STORAGE_KEYS = {
      QQ: 'qqConfig',
      MUSIC: 'musicPlayerConfig',
      EMOJI: 'qqEmojiStorage',
      API: 'apiManagerConfigs',
      IMAGE: 'qqImageStorage'
    };
    // å…¨å±€çŠ¶æ€
    let currentChatId = -1;
    let currentContact = null;
    let selectedMsgId = -1;
    let emojiList = [];
    let isVoiceInput = false; // è¯­éŸ³è¾“å…¥çŠ¶æ€
    let isRecording = false; // å½•éŸ³çŠ¶æ€
    let globalAudio = new Audio(); // éŸ³ä¹æ’­æ”¾å¯¹è±¡

    // é¡µé¢åˆå§‹åŒ–
    window.onload = initChatPage();

    // 1. åˆå§‹åŒ–èŠå¤©é¡µé¢ï¼ˆä¿®å¤å›¾ç‰‡æœ¬åœ°ä¿å­˜ï¼‰
    async function initChatPage() {
      // è·å–å½“å‰èŠå¤©ID
      currentChatId = localStorage.getItem('currentChatContactId');
      if (!currentChatId) {
        backToQQMain();
        return;
      }
      currentChatId = parseInt(currentChatId);

      // åŠ è½½QQé…ç½®
      const savedQQ = localStorage.getItem(STORAGE_KEYS.QQ);
      if (!savedQQ) {
        backToQQMain();
        return;
      }
      const qqConfig = JSON.parse(savedQQ);
      currentContact = qqConfig.contacts.find(contact => contact.id === currentChatId);
      if (!currentContact) {
        backToQQMain();
        return;
      }
      // åˆå§‹åŒ–é»˜è®¤å€¼
      if (!currentContact.chatLogs) currentContact.chatLogs = [];
      if (currentContact.isBlocked === undefined) currentContact.isBlocked = false;

      // æ¢å¤å›¾ç‰‡ï¼ˆä»imageMapè¯»å–Base64ï¼‰
      if (qqConfig.imageMap) {
        // æ¢å¤è”ç³»äººå¤´åƒ/èƒŒæ™¯
        if (currentContact.avatar && qqConfig.imageMap[currentContact.avatar]) {
          currentContact.avatar = qqConfig.imageMap[currentContact.avatar];
        }
        if (currentContact.bg && qqConfig.imageMap[currentContact.bg]) {
          currentContact.bg = qqConfig.imageMap[currentContact.bg];
        }
        // æ¢å¤èŠå¤©è®°å½•ä¸­çš„å›¾ç‰‡
        currentContact.chatLogs.forEach(log => {
          if (log.media?.url && qqConfig.imageMap[log.media.url]) {
            log.media.url = qqConfig.imageMap[log.media.url];
          }
          if (log.emojiUrl && qqConfig.imageMap[log.emojiUrl]) {
            log.emojiUrl = qqConfig.imageMap[log.emojiUrl];
          }
        });
      }

      // åŠ è½½è¡¨æƒ…åŒ…
      const savedEmoji = localStorage.getItem(STORAGE_KEYS.EMOJI);
      emojiList = savedEmoji ? JSON.parse(savedEmoji) : [];
      renderEmojiGrid();

      // æ¸²æŸ“åŸºç¡€ä¿¡æ¯
      renderChatBaseInfo();
      // æ¸²æŸ“èŠå¤©è®°å½•
      renderChatLogs();
      // æ¸²æŸ“éŸ³ä¹åˆ—è¡¨
      renderMusicList();
      // æ¸²æŸ“APIåˆ—è¡¨
      renderApiSelect();
      // æ›´æ–°æ‹‰é»‘æŒ‰é’®çŠ¶æ€
      updateBlockBtnStatus();
    }

    // 2. æ¸²æŸ“èŠå¤©åŸºç¡€ä¿¡æ¯
    function renderChatBaseInfo() {
      // æ ‡é¢˜
      document.getElementById('chatName').textContent = currentContact.name;
      // èƒŒæ™¯
      const chatBg = document.getElementById('chatBg');
      chatBg.innerHTML = `<img src="${currentContact.bg || 'app.img/default-bg.jpg'}" alt="èŠå¤©èƒŒæ™¯">`;
      // è®¾ç½®é¡µåˆå§‹å€¼
      document.getElementById('settingAvatarImg').src = currentContact.avatar || 'app.img/default-contact.png';
      document.getElementById('settingName').value = currentContact.name;
      document.getElementById('settingBgImg').src = currentContact.bg || 'app.img/default-bg.jpg';
      document.getElementById('settingPersona').value = currentContact.setting || '';
    }

    // 3. å›¾ç‰‡è½¬Base64ï¼ˆæŒä¹…åŒ–æ ¸å¿ƒï¼‰
    function imageToBase64(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.readAsDataURL(file);
      });
    }

    // 4. è¡¨æƒ…åŒ…åŠŸèƒ½ï¼ˆä¿®å¤æœ¬åœ°ä¿å­˜ï¼‰
    async function addEmoji(input) {
      const file = input.files[0];
      if (!file) return;
      // è½¬Base64
      const base64Url = await imageToBase64(file);
      const emoji = {
        id: Date.now(),
        url: base64Url,
        fileName: file.name
      };
      // æ·»åŠ åˆ°åˆ—è¡¨å¹¶æŒä¹…åŒ–
      emojiList.push(emoji);
      localStorage.setItem(STORAGE_KEYS.EMOJI, JSON.stringify(emojiList));
      // åŒæ­¥åˆ°QQé…ç½®çš„imageMap
      const savedQQ = localStorage.getItem(STORAGE_KEYS.QQ);
      const qqConfig = savedQQ ? JSON.parse(savedQQ) : { imageMap: {} };
      qqConfig.imageMap[emoji.id] = base64Url;
      localStorage.setItem(STORAGE_KEYS.QQ, JSON.stringify(qqConfig));
      // é‡æ–°æ¸²æŸ“
      renderEmojiGrid();
      input.value = '';
    }

    function renderEmojiGrid() {
      const emojiGrid = document.getElementById('emojiGrid');
      const emptyTip = document.getElementById('emptyEmojiTip');

      if (emojiList.length === 0) {
        emptyTip.style.display = 'flex';
        emojiGrid.innerHTML = '';
        emojiGrid.appendChild(emptyTip);
        return;
      }

      emptyTip.style.display = 'none';
      let html = '';
      emojiList.forEach(emoji => {
        html += `
          <div class="emoji-item" onclick="sendEmoji(${emoji.id})">
            <img src="${emoji.url}" alt="è¡¨æƒ…åŒ…">
          </div>
        `;
      });
      emojiGrid.innerHTML = html;
    }

    // å‘é€è¡¨æƒ…åŒ…ï¼ˆæ— æ°”æ³¡ï¼Œçº¯å›¾ç‰‡ï¼‰
    async function sendEmoji(emojiId) {
      const emoji = emojiList.find(e => e.id === emojiId);
      if (!emoji) return;

      // åˆ›å»ºè¡¨æƒ…åŒ…æ¶ˆæ¯
      const emojiMsg = {
        id: Date.now(),
        type: 'emoji',
        emojiUrl: emoji.url,
        time: new Date().toISOString(),
        isUser: true
      };
      currentContact.chatLogs.push(emojiMsg);
      saveQQConfig();
      renderChatLogs();

      // å…³é—­è¡¨æƒ…åŒ…å¼¹çª—
      document.getElementById('emojiModal').classList.remove('active');
    }

    // 5. è¯­éŸ³è¾“å…¥åŠŸèƒ½
    function switchToVoiceInput() {
      isVoiceInput = true;
      // æ˜¾ç¤ºè¯­éŸ³è¾“å…¥æ¡†ï¼Œéšè—æ–‡å­—è¾“å…¥æ¡†
      document.getElementById('chatInput').style.display = 'none';
      document.getElementById('voiceInput').style.display = 'flex';
      // æ˜¾ç¤ºæ–‡å­—åˆ‡æ¢æŒ‰é’®ï¼Œéšè—å‘é€/è¯­éŸ³æŒ‰é’®
      document.getElementById('sendBtn').style.display = 'none';
      document.getElementById('voiceBtn').style.display = 'none';
      document.getElementById('switchTextBtn').style.display = 'block';
    }

    function switchToTextInput() {
      isVoiceInput = false;
      // æ˜¾ç¤ºæ–‡å­—è¾“å…¥æ¡†ï¼Œéšè—è¯­éŸ³è¾“å…¥æ¡†
      document.getElementById('voiceInput').style.display = 'none';
      document.getElementById('chatInput').style.display = 'block';
      // æ˜¾ç¤ºå‘é€/è¯­éŸ³æŒ‰é’®ï¼Œéšè—æ–‡å­—åˆ‡æ¢æŒ‰é’®
      document.getElementById('sendBtn').style.display = 'block';
      document.getElementById('voiceBtn').style.display = 'block';
      document.getElementById('switchTextBtn').style.display = 'none';
      // åœæ­¢å½•éŸ³ï¼ˆé˜²æ­¢è¯¯è§¦ï¼‰
      if (isRecording) stopRecord();
    }

    function startRecord() {
      isRecording = true;
      document.querySelector('.voice-tip').textContent = 'æ­£åœ¨å½•éŸ³...';
      // æ¨¡æ‹Ÿå½•éŸ³ï¼ˆå®é™…é¡¹ç›®éœ€å¯¹æ¥å½•éŸ³APIï¼‰
    }

    function stopRecord() {
      if (!isRecording) return;
      isRecording = false;
      document.querySelector('.voice-tip').textContent = 'é•¿æŒ‰å½•éŸ³';
      // æ¨¡æ‹Ÿå‘é€è¯­éŸ³æ¶ˆæ¯
      const voiceMsg = {
        id: Date.now(),
        type: 'voice',
        content: 'è¯­éŸ³æ¶ˆæ¯ï¼ˆ3ç§’ï¼‰',
        time: new Date().toISOString(),
        isUser: true
      };
      currentContact.chatLogs.push(voiceMsg);
      saveQQConfig();
      renderChatLogs();

      // æ¨¡æ‹ŸAIå›å¤
      setTimeout(() => {
        const aiVoiceMsg = {
          id: Date.now() + 1,
          type: 'voice',
          content: 'æ”¶åˆ°ä½ çš„è¯­éŸ³æ¶ˆæ¯å•¦ï½',
          time: new Date().toISOString(),
          isUser: false
        };
        currentContact.chatLogs.push(aiVoiceMsg);
        saveQQConfig();
        renderChatLogs();
      }, 1000);
    }

    // 6. è½¬è´¦åŠŸèƒ½ï¼ˆè“è‰²å¡ç‰‡ï¼‰
    function toggleTransferModal() {
      const modal = document.getElementById('transferModal');
      modal.classList.toggle('active');
    }

    async function confirmTransfer() {
      const amount = parseFloat(document.getElementById('transferAmount').value);
      const remark = document.getElementById('transferRemark').value.trim();
      if (isNaN(amount) || amount <= 0) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„è½¬è´¦é‡‘é¢ï¼');
        return;
      }

      // åˆ›å»ºè½¬è´¦æ¶ˆæ¯ï¼ˆå¡ç‰‡å½¢å¼ï¼‰
      const transferMsg = {
        id: Date.now(),
        type: 'transfer',
        amount: amount,
        remark: remark,
        time: new Date().toISOString(),
        isUser: true
      };
      currentContact.chatLogs.push(transferMsg);
      saveQQConfig();
      renderChatLogs();

      // æç¤ºå¹¶å…³é—­å¼¹çª—
      alert(`è½¬è´¦ ${amount} å…ƒç»™ ${currentContact.name} æˆåŠŸï¼`);
      toggleTransferModal();
      document.getElementById('transferAmount').value = '';
      document.getElementById('transferRemark').value = '';

      // æ¨¡æ‹ŸAIæ”¶æ¬¾å›å¤
      setTimeout(() => {
        const aiReply = {
          id: Date.now() + 1,
          type: 'text',
          content: `å·²æ”¶åˆ°ä½ çš„ ${amount} å…ƒè½¬è´¦${remark ? 'ï¼Œå¤‡æ³¨ï¼š' + remark : ''}`,
          time: new Date().toISOString(),
          isUser: false
        };
        currentContact.chatLogs.push(aiReply);
        saveQQConfig();
        renderChatLogs();
      }, 1000);
    }

    // 7. çº¢åŒ…åŠŸèƒ½ï¼ˆçº¢è‰²å¡ç‰‡ï¼‰
    function toggleRedpacketModal() {
      const modal = document.getElementById('redpacketModal');
      modal.classList.toggle('active');
    }

    async function confirmRedpacket() {
      const amount = parseFloat(document.getElementById('redpacketAmount').value);
      const remark = document.getElementById('redpacketRemark').value.trim() || 'æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©';
      if (isNaN(amount) || amount <= 0) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„çº¢åŒ…é‡‘é¢ï¼');
        return;
      }

      // åˆ›å»ºçº¢åŒ…æ¶ˆæ¯ï¼ˆå¡ç‰‡å½¢å¼ï¼‰
      const redpacketMsg = {
        id: Date.now(),
        type: 'redpacket',
        amount: amount,
        remark: remark,
        time: new Date().toISOString(),
        isUser: true
      };
      currentContact.chatLogs.push(redpacketMsg);
      saveQQConfig();
      renderChatLogs();

      // æç¤ºå¹¶å…³é—­å¼¹çª—
      alert(`ç»™ ${currentContact.name} å‘é€ ${amount} å…ƒçº¢åŒ…æˆåŠŸï¼`);
      toggleRedpacketModal();
      document.getElementById('redpacketAmount').value = '';
      document.getElementById('redpacketRemark').value = '';

      // æ¨¡æ‹ŸAIæŠ¢çº¢åŒ…å›å¤
      setTimeout(() => {
        const aiReply = {
          id: Date.now() + 1,
          type: 'text',
          content: `å·²é¢†å–ä½ çš„çº¢åŒ…ï¼Œé‡‘é¢ ${amount} å…ƒï¼Œè°¢è°¢ï½`,
          time: new Date().toISOString(),
          isUser: false
        };
        currentContact.chatLogs.push(aiReply);
        saveQQConfig();
        renderChatLogs();
      }, 1000);
    }

    // 8. éŸ³ä¹åˆ†äº«åŠŸèƒ½ï¼ˆå¡ç‰‡+æ’­æ”¾ï¼‰
    function renderMusicList() {
      const musicList = document.getElementById('musicList');
      const savedMusic = localStorage.getItem(STORAGE_KEYS.MUSIC);
      if (!savedMusic) {
        musicList.innerHTML = `<div style="text-align:center; color:#999; font-size:12px; padding:10px;">æš‚æ— éŸ³ä¹</div>`;
        return;
      }

      const { songList } = JSON.parse(savedMusic);
      if (songList.length === 0) {
        musicList.innerHTML = `<div style="text-align:center; color:#999; font-size:12px; padding:10px;">æš‚æ— éŸ³ä¹</div>`;
        return;
      }

      let html = '';
      songList.forEach(song => {
        html += `<div class="music-item" onclick="shareMusic('${song.name}', '${song.singer}', '${song.url}')">${song.name} - ${song.singer}</div>`;
      });
      musicList.innerHTML = html;
    }

    function shareMusic(musicName, musicSinger, musicUrl) {
      // åˆ›å»ºéŸ³ä¹æ¶ˆæ¯ï¼ˆå¡ç‰‡å½¢å¼ï¼‰
      const musicMsg = {
        id: Date.now(),
        type: 'music',
        musicName: musicName,
        musicSinger: musicSinger,
        musicUrl: musicUrl,
        time: new Date().toISOString(),
        isUser: true
      };
      currentContact.chatLogs.push(musicMsg);
      saveQQConfig();
      renderChatLogs();

      // å…³é—­éŸ³ä¹å¼¹çª—
      document.getElementById('musicModal').classList.remove('active');
    }

    // æ’­æ”¾éŸ³ä¹
    function playMusic(musicUrl) {
      if (globalAudio.src === musicUrl && !globalAudio.paused) {
        globalAudio.pause();
        return;
      }
      globalAudio.src = musicUrl;
      globalAudio.play().catch(err => console.log('æ’­æ”¾å¤±è´¥', err));
    }

    // 9. æ¶ˆæ¯é•¿æŒ‰èœå•ï¼ˆé€‚é…å®½åº¦ï¼‰
    function showMsgMenu(event, msgId) {
      event.preventDefault();
      selectedMsgId = msgId;
      const msgMenu = document.getElementById('msgMenu');
      const msgBubble = event.target.closest('.msg-bubble, .special-msg-card, .emoji-item');
      if (!msgBubble) return;

      // å®šä½åˆ°æ°”æ³¡ä¸‹æ–¹ï¼Œå®½åº¦é€‚é…æ–‡å­—
      const bubbleRect = msgBubble.getBoundingClientRect();
      const screenRect = document.querySelector('.phone-screen').getBoundingClientRect();
      msgMenu.style.left = `${bubbleRect.left - screenRect.left + bubbleRect.width/2 - msgMenu.offsetWidth/2}px`;
      msgMenu.style.top = `${bubbleRect.bottom - screenRect.top}px`;
      msgMenu.style.display = 'block';
    }

    // æ¶ˆæ¯ç¼–è¾‘ï¼ˆæ”¯æŒç”¨æˆ·å’ŒAIæ¶ˆæ¯ï¼‰
    function editMsg() {
      const chatLogs = currentContact.chatLogs;
      const targetMsg = chatLogs.find(log => log.id === selectedMsgId);
      if (!targetMsg) return;

      // ä¸åŒç±»å‹æ¶ˆæ¯ç¼–è¾‘é€»è¾‘
      let newContent = '';
      if (targetMsg.type === 'text') {
        newContent = prompt('ç¼–è¾‘æ¶ˆæ¯', targetMsg.content);
        if (newContent !== null && newContent.trim() !== '') {
          targetMsg.content = newContent;
        }
      } else if (targetMsg.type === 'transfer' || targetMsg.type === 'redpacket') {
        newContent = prompt('ç¼–è¾‘å¤‡æ³¨', targetMsg.remark || '');
        if (newContent !== null) {
          targetMsg.remark = newContent;
        }
      } else if (targetMsg.type === 'music') {
        newContent = prompt('ç¼–è¾‘éŸ³ä¹åç§°', targetMsg.musicName);
        if (newContent !== null && newContent.trim() !== '') {
          targetMsg.musicName = newContent;
        }
      }

      if (newContent !== null) {
        saveQQConfig();
        renderChatLogs();
      }
      document.getElementById('msgMenu').style.display = 'none';
    }

    // 10. æ‹‰é»‘åŠŸèƒ½
    function toggleBlockContact() {
      currentContact.isBlocked = !currentContact.isBlocked;
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      updateBlockBtnStatus();
      // æç¤º
      alert(currentContact.isBlocked ? 'å·²æ‹‰é»‘è¯¥è”ç³»äººï¼Œå¯¹æ–¹æ¶ˆæ¯å°†è¢«æ‹’æ”¶' : 'å·²å–æ¶ˆæ‹‰é»‘ï¼Œå¯æ­£å¸¸æ¥æ”¶æ¶ˆæ¯');
      saveQQConfig();
    }

    function updateBlockBtnStatus() {
      const blockBtn = document.getElementById('blockBtn');
      if (currentContact.isBlocked) {
        blockBtn.textContent = 'å–æ¶ˆæ‹‰é»‘';
        blockBtn.classList.add('unblock-btn');
      } else {
        blockBtn.textContent = 'æ‹‰é»‘è¯¥è”ç³»äºº';
        blockBtn.classList.remove('unblock-btn');
      }
    }

    // 11. æ¸²æŸ“èŠå¤©è®°å½•ï¼ˆå«æ‰€æœ‰æ¶ˆæ¯ç±»å‹+æ‹‰é»‘æç¤ºï¼‰
    function renderChatLogs() {
      const chatContainer = document.getElementById('chatContainer');
      const chatLogs = currentContact.chatLogs;

      if (chatLogs.length === 0) {
        chatContainer.innerHTML = `
          <div style="text-align:center; color:#999; font-size:12px; margin-top:50%;">
            å¼€å§‹èŠå¤©å§ï½
          </div>
        `;
        return;
      }

      let html = '';
           chatLogs.forEach(log => {
        const timeStr = new Date(log.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        // æ‹‰é»‘æç¤ºï¼šAIæ¶ˆæ¯æ˜¾ç¤ºçº¢è‰²æ„Ÿå¹å·
        const blockTip = log.isUser === false && currentContact.isBlocked ? 
          `<div class="block-tip active">å¯¹æ–¹æ‹’ç»æ¥æ”¶ä½ çš„æ¶ˆæ¯</div>` : '';

        // 1. æ–‡æœ¬æ¶ˆæ¯ï¼ˆå¸¦å¤´åƒï¼‰
        if (log.type === 'text' || !log.type) {
          html += `
            <div class="msg-container ${log.isUser ? 'self-msg-container' : 'other-msg-container'}">
              <div class="msg-avatar">
                <img src="${log.isUser ? qqConfig.userAvatar : currentContact.avatar || 'app.img/default-contact.png'}" alt="å¤´åƒ">
              </div>
              <div class="msg-bubble ${log.isUser ? 'self-msg' : 'other-msg'}" 
                   data-msg-id="${log.id}" 
                   oncontextmenu="showMsgMenu(event, ${log.id})">
                <div>${log.content}</div>
                <div class="msg-time">${timeStr}</div>
              </div>
            </div>
            ${blockTip}
          `;
        }

        // 2. è¡¨æƒ…åŒ…æ¶ˆæ¯ï¼ˆæ— æ°”æ³¡ï¼Œçº¯å›¾ç‰‡ï¼‰
        else if (log.type === 'emoji') {
          html += `
            <div class="msg-container ${log.isUser ? 'self-msg-container' : 'other-msg-container'}">
              <div class="msg-avatar">
                <img src="${log.isUser ? qqConfig.userAvatar : currentContact.avatar || 'app.img/default-contact.png'}" alt="å¤´åƒ">
              </div>
              <div class="emoji-item" data-msg-id="${log.id}" oncontextmenu="showMsgMenu(event, ${log.id})">
                <img src="${log.emojiUrl}" alt="è¡¨æƒ…åŒ…">
                <div class="msg-time" style="text-align:${log.isUser ? 'right' : 'left'}; margin-top:5px; font-size:10px; opacity:0.7;">${timeStr}</div>
              </div>
            </div>
            ${blockTip}
          `;
        }

        // 3. è½¬è´¦æ¶ˆæ¯ï¼ˆè“è‰²å¡ç‰‡ï¼‰
        else if (log.type === 'transfer') {
          html += `
            <div class="${log.isUser ? 'self-msg-container' : 'other-msg-container'}" style="display:flex; margin-bottom:15px;">
              <div class="msg-avatar">
                <img src="${log.isUser ? qqConfig.userAvatar : currentContact.avatar || 'app.img/default-contact.png'}" alt="å¤´åƒ">
              </div>
              <div class="special-msg-card transfer-card" data-msg-id="${log.id}" oncontextmenu="showMsgMenu(event, ${log.id})">
                <div class="card-header">è½¬è´¦</div>
                <div class="card-body">
                  <div>${log.remark || 'æ— å¤‡æ³¨'}</div>
                  <div class="transfer-amount">Â¥${log.amount.toFixed(2)}</div>
                  <div style="font-size:12px; color:#999;">${timeStr}</div>
                </div>
              </div>
            </div>
            ${blockTip}
          `;
        }

        // 4. çº¢åŒ…æ¶ˆæ¯ï¼ˆçº¢è‰²å¡ç‰‡ï¼‰
        else if (log.type === 'redpacket') {
          html += `
            <div class="${log.isUser ? 'self-msg-container' : 'other-msg-container'}" style="display:flex; margin-bottom:15px;">
              <div class="msg-avatar">
                <img src="${log.isUser ? qqConfig.userAvatar : currentContact.avatar || 'app.img/default-contact.png'}" alt="å¤´åƒ">
              </div>
              <div class="special-msg-card redpacket-card" data-msg-id="${log.id}" oncontextmenu="showMsgMenu(event, ${log.id})">
                <div class="card-header">çº¢åŒ…</div>
                <div class="card-body">
                  <div>${log.remark}</div>
                  <div class="redpacket-amount">Â¥${log.amount.toFixed(2)}</div>
                  <div style="font-size:12px; color:#999;">${timeStr}</div>
                </div>
              </div>
            </div>
            ${blockTip}
          `;
        }

        // 5. éŸ³ä¹æ¶ˆæ¯ï¼ˆç»¿è‰²å¡ç‰‡+æ’­æ”¾åŠŸèƒ½ï¼‰
        else if (log.type === 'music') {
          html += `
            <div class="${log.isUser ? 'self-msg-container' : 'other-msg-container'}" style="display:flex; margin-bottom:15px;">
              <div class="msg-avatar">
                <img src="${log.isUser ? qqConfig.userAvatar : currentContact.avatar || 'app.img/default-contact.png'}" alt="å¤´åƒ">
              </div>
              <div class="special-msg-card music-card" data-msg-id="${log.id}" oncontextmenu="showMsgMenu(event, ${log.id})">
                <div class="card-header">éŸ³ä¹åˆ†äº«</div>
                <div class="card-body">
                  <div class="music-info">
                    <div class="music-cover">ğŸµ</div>
                    <div class="music-text">
                      <div class="music-name">${log.musicName}</div>
                      <div class="music-singer">${log.musicSinger}</div>
                    </div>
                    <div class="play-btn" onclick="playMusic('${log.musicUrl}')">â–¶</div>
                  </div>
                  <div style="font-size:12px; color:#999; margin-top:10px;">${timeStr}</div>
                </div>
              </div>
            </div>
            ${blockTip}
          `;
        }

        // 6. è¯­éŸ³æ¶ˆæ¯
        else if (log.type === 'voice') {
          html += `
            <div class="msg-container ${log.isUser ? 'self-msg-container' : 'other-msg-container'}">
              <div class="msg-avatar">
                <img src="${log.isUser ? qqConfig.userAvatar : currentContact.avatar || 'app.img/default-contact.png'}" alt="å¤´åƒ">
              </div>
              <div class="msg-bubble ${log.isUser ? 'self-msg' : 'other-msg'}" 
                   data-msg-id="${log.id}" 
                   oncontextmenu="showMsgMenu(event, ${log.id})">
                <div style="display:flex; align-items:center; gap:10px;">
                  <div>ğŸ¤ ${log.content}</div>
                </div>
                <div class="msg-time">${timeStr}</div>
              </div>
            </div>
            ${blockTip}
          `;
        }
      });

      chatContainer.innerHTML = html;
      // æ»šåŠ¨åˆ°åº•éƒ¨
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // 12. ä¿å­˜QQé…ç½®ï¼ˆå«å›¾ç‰‡Base64ï¼‰
    function saveQQConfig() {
      const savedQQ = localStorage.getItem(STORAGE_KEYS.QQ);
      const qqConfig = savedQQ ? JSON.parse(savedQQ) : { contacts: [], moments: [], emojiList: [], imageMap: {} };
      const contactIndex = qqConfig.contacts.findIndex(contact => contact.id === currentChatId);
      if (contactIndex !== -1) {
        qqConfig.contacts[contactIndex] = currentContact;
      }
      // åŒæ­¥è¡¨æƒ…åŒ…åˆ°QQé…ç½®
      qqConfig.emojiList = emojiList;
      localStorage.setItem(STORAGE_KEYS.QQ, JSON.stringify(qqConfig));
      // å•ç‹¬ä¿å­˜è¡¨æƒ…åŒ…
      localStorage.setItem(STORAGE_KEYS.EMOJI, JSON.stringify(emojiList));
    }

    // 13. å…¶ä»–åŸæœ‰å‡½æ•°ï¼ˆæ¶ˆæ¯å‘é€ã€å›æº¯ã€åˆ é™¤ç­‰ï¼‰
    function sendMsg() {
      if (isVoiceInput) return; // è¯­éŸ³æ¨¡å¼ä¸‹ä¸è§¦å‘æ–‡å­—å‘é€
      const input = document.getElementById('chatInput');
      const content = input.value.trim();
      if (!content) return;

      // æ£€æŸ¥æ˜¯å¦è¢«æ‹‰é»‘ï¼ˆç”¨æˆ·å‘é€æ—¶æç¤ºï¼‰
      if (currentContact.isBlocked) {
        alert('ä½ å·²æ‹‰é»‘è¯¥è”ç³»äººï¼Œæ¶ˆæ¯æ— æ³•å‘é€');
        return;
      }

      // åˆ›å»ºæ–‡æœ¬æ¶ˆæ¯
      const newMsg = {
        id: Date.now(),
        type: 'text',
        content: content,
        time: new Date().toISOString(),
        isUser: true
      };
      currentContact.chatLogs.push(newMsg);
      saveQQConfig();
      renderChatLogs();
      input.value = '';

      // æ¨¡æ‹ŸAIå›å¤ï¼ˆæ‹‰é»‘çŠ¶æ€ä¸‹ä¸å›å¤ï¼‰
      if (!currentContact.isBlocked) {
        setTimeout(() => {
          const aiReply = {
            id: Date.now() + 1,
            type: 'text',
            content: `æ”¶åˆ°ä½ çš„æ¶ˆæ¯ï¼š${content}`,
            time: new Date().toISOString(),
            isUser: false
          };
          currentContact.chatLogs.push(aiReply);
          saveQQConfig();
          renderChatLogs();
        }, 1000);
      }
    }

    function traceMsg() {
      const chatLogs = currentContact.chatLogs;
      const targetMsg = chatLogs.find(log => log.id === selectedMsgId);
      if (targetMsg) {
        const chatContainer = document.getElementById('chatContainer');
        const msgDom = document.querySelector(`[data-msg-id="${selectedMsgId}"]`);
        if (msgDom) {
          msgDom.scrollIntoView({ behavior: 'smooth', block: 'center' });
          msgDom.style.boxShadow = '0 0 0 2px #0084ff';
          setTimeout(() => msgDom.style.boxShadow = 'none', 2000);
        }
        alert(`å·²å›æº¯åˆ° ${new Date(targetMsg.time).toLocaleTimeString()} çš„æ¶ˆæ¯`);
      }
      document.getElementById('msgMenu').style.display = 'none';
    }

    function deleteMsg() {
      const chatLogs = currentContact.chatLogs;
      const targetIndex = chatLogs.findIndex(log => log.id === selectedMsgId);
      if (targetIndex !== -1) {
        chatLogs.splice(targetIndex, 1);
        saveQQConfig();
        renderChatLogs();
      }
      document.getElementById('msgMenu').style.display = 'none';
    }

    // 14. è”ç³»äººè®¾ç½®ç›¸å…³å‡½æ•°
    function toggleContactSetting() {
      const settingPage = document.getElementById('contactSettingPage');
      settingPage.classList.toggle('active');
      renderApiSelect();
    }

    function renderApiSelect() {
      const apiSelect = document.getElementById('settingApiSelect');
      const savedApi = localStorage.getItem(STORAGE_KEYS.API);
      if (!savedApi) return;

      const apiList = JSON.parse(savedApi);
      apiSelect.innerHTML = '<option value="-1">è¯·é€‰æ‹©API</option>';
      apiList.forEach(api => {
        const option = document.createElement('option');
        option.value = api.apiKey;
        option.textContent = api.apiName;
        if (currentContact.apiId === api.apiKey) {
          option.selected = true;
        }
        apiSelect.appendChild(option);
      });
    }

    async function updateSettingAvatar(input) {
      const file = input.files[0];
      if (!file) return;
      // è½¬Base64å¹¶ä¿å­˜
      const base64Url = await imageToBase64(file);
      currentContact.avatar = base64Url;
      // åŒæ­¥åˆ°imageMap
      const savedQQ = localStorage.getItem(STORAGE_KEYS.QQ);
      const qqConfig = savedQQ ? JSON.parse(savedQQ) : { imageMap: {} };
      qqConfig.imageMap[`avatar_${currentContact.id}`] = base64Url;
      localStorage.setItem(STORAGE_KEYS.QQ, JSON.stringify(qqConfig));
      // æ›´æ–°DOM
      document.getElementById('settingAvatarImg').src = base64Url;
      input.value = '';
    }

    async function updateSettingBg(input) {
      const file = input.files[0];
      if (!file) return;
      // è½¬Base64å¹¶ä¿å­˜
      const base64Url = await imageToBase64(file);
      currentContact.bg = base64Url;
      // åŒæ­¥åˆ°imageMap
      const savedQQ = localStorage.getItem(STORAGE_KEYS.QQ);
      const qqConfig = savedQQ ? JSON.parse(savedQQ) : { imageMap: {} };
      qqConfig.imageMap[`bg_${currentContact.id}`] = base64Url;
      localStorage.setItem(STORAGE_KEYS.QQ, JSON.stringify(qqConfig));
      // æ›´æ–°DOM
      document.getElementById('settingBgImg').src = base64Url;
      document.getElementById('chatBg').innerHTML = `<img src="${base64Url}" alt="èŠå¤©èƒŒæ™¯">`;
      input.value = '';
    }

    function deleteAllChatLogs() {
      if (confirm('ç¡®å®šåˆ é™¤æ‰€æœ‰èŠå¤©è®°å½•ï¼Ÿ')) {
        currentContact.chatLogs = [];
        saveQQConfig();
        renderChatLogs();
        alert('æ‰€æœ‰èŠå¤©è®°å½•å·²åˆ é™¤ï¼');
      }
    }

    function deleteContact() {
      if (confirm('ç¡®å®šåˆ é™¤è¯¥è”ç³»äººï¼Ÿåˆ é™¤åä¸å¯æ¢å¤ï¼')) {
        const savedQQ = localStorage.getItem(STORAGE_KEYS.QQ);
        const qqConfig = JSON.parse(savedQQ);
        qqConfig.contacts = qqConfig.contacts.filter(contact => contact.id !== currentChatId);
        localStorage.setItem(STORAGE_KEYS.QQ, JSON.stringify(qqConfig));
        backToQQMain();
      }
    }

    // 15. é¡µé¢è·³è½¬ä¸åŠŸèƒ½å¼¹çª—æ§åˆ¶
    function backToContactDetail() {
      saveQQConfig();
      localStorage.setItem('currentContactId', currentChatId);
      window.location.href = 'qq-contact-detail.html';
    }

    function backToQQMain() {
      saveQQConfig();
      localStorage.removeItem('currentChatContactId');
      localStorage.removeItem('currentContactId');
      window.location.href = 'qq-main.html';
    }

    function toggleFuncModal() {
      const funcModal = document.getElementById('funcModal');
      const otherModals = [
        document.getElementById('emojiModal'),
        document.getElementById('musicModal'),
        document.getElementById('transferModal'),
        document.getElementById('redpacketModal')
      ];
      otherModals.forEach(modal => modal.classList.remove('active'));
      funcModal.classList.toggle('active');
    }

    function toggleEmojiModal() {
      const emojiModal = document.getElementById('emojiModal');
      const funcModal = document.getElementById('funcModal');
      funcModal.classList.remove('active');
      emojiModal.classList.toggle('active');
    }

    function toggleMusicModal() {
      const musicModal = document.getElementById('musicModal');
      const funcModal = document.getElementById('funcModal');
      funcModal.classList.remove('active');
      musicModal.classList.toggle('active');
      renderMusicList();
    }

    // 16. ç‚¹å‡»ç©ºç™½å¤„å…³é—­èœå•
    document.addEventListener('click', (e) => {
      const msgMenu = document.getElementById('msgMenu');
      if (!msgMenu.contains(e.target) && !e.target.closest('[data-msg-id]')) {
        msgMenu.style.display = 'none';
      }
    });

    // 17. é”®ç›˜å›è½¦å‘é€æ¶ˆæ¯
    document.getElementById('chatInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !isVoiceInput) {
        sendMsg();
      }
    });
  </script>
</body>
</html>




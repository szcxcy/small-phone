<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>å¯çˆ±QQ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "PingFang SC", "å¾®è½¯é›…é»‘", sans-serif;
    }
    body {
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #f5f5f5;
    }
    /* æ‰‹æœºå®¹å™¨ */
    .phone-screen {
      width: 375px;
      height: 812px;
      border: 1px solid #eee;
      border-radius: 40px;
      overflow: hidden;
      position: relative;
      background: #fff;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    /* è¿”å›é”® */
    .back-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      width: 36px;
      height: 36px;
      background: #f8dce8;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(255,182,193,0.3);
      z-index: 999;
    }
    .back-btn::after {
      content: '';
      width: 14px;
      height: 14px;
      border-top: 2px solid #ffabb8;
      border-left: 2px solid #ffabb8;
      transform: rotate(-45deg);
    }
    /* ç”¨æˆ·å¤´åƒï¼šç§»è‡³å·¦ä¸Šè§’ï¼ˆè¿”å›é”®å³ä¾§ï¼‰ */
    .user-avatar {
      position: absolute;
      top: 20px;
      left: 70px; /* ä¸è¿”å›é”®é—´è·14px */
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #eee;
      overflow: hidden;
      cursor: pointer;
      z-index: 998;
    }
    .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    /* å¤´åƒèœå•ï¼šè·Ÿéšå¤´åƒä½ç½®è°ƒæ•´ */
    .avatar-menu {
      position: absolute;
      top: 65px;
      left: 70px;
      width: 120px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 997;
      display: none;
    }
    .avatar-menu.active {
      display: block;
    }
    .menu-item {
      padding: 8px 12px;
      font-size: 14px;
      color: #333;
      cursor: pointer;
    }
    .menu-item:hover {
      background: #f5f5f5;
    }
    /* å¤´åƒæ”¾å¤§å¼¹çª— */
    .avatar-modal {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 200px;
      height: 200px;
      border-radius: 50%;
      background: #eee;
      overflow: hidden;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
      z-index: 1000;
      display: none;
    }
    .avatar-modal.active {
      display: block;
    }
    .avatar-modal img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .close-modal {
      position: absolute;
      bottom: -40px;
      left: 50%;
      transform: translateX(-50%);
      padding: 5px 15px;
      background: #ff69b4;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    /* æœç´¢æ¡† */
    .search-bar {
      position: absolute;
      top: 20px;
      left: 120px; /* ç»™å¤´åƒç•™ç©ºé—´ */
      right: 70px; /* ç»™åŠ å·ç•™ç©ºé—´ */
      height: 36px;
      background: #f5f5f5;
      border-radius: 18px;
      padding: 0 15px;
      display: flex;
      align-items: center;
      font-size: 14px;
      color: #999;
      z-index: 996;
    }
    .search-bar input {
      width: 100%;
      background: transparent;
      border: none;
      outline: none;
      margin-left: 5px;
    }
    /* å³ä¸Šè§’åŠ å· */
    .add-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 36px;
      height: 36px;
      background: #ff69b4;
      color: #fff;
      border: none;
      border-radius: 50%;
      font-size: 20px;
      line-height: 36px;
      text-align: center;
      cursor: pointer;
      z-index: 995;
      display: block;
    }
    /* åŠ å·èœå• */
    .add-menu {
      position: absolute;
      top: 65px;
      right: 20px;
      width: 150px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 994;
      display: none;
    }
    .add-menu.active {
      display: block;
    }
    /* åº•éƒ¨Tabæ  */
    .tab-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 55px;
      display: flex;
      border-top: 1px solid #f5f5f5;
      background: #fff;
      z-index: 990;
    }
    .tab-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-size: 12px;
      color: #999;
      cursor: pointer;
      gap: 4px;
    }
    .tab-item.active {
      color: #ff69b4;
    }
    .tab-icon {
      font-size: 20px;
    }
    /* å†…å®¹åŒºï¼šè°ƒæ•´ä¸ºæœç´¢æ ä¸‹æ–¹ä»ä¸Šæ’åˆ—ï¼ˆç§»é™¤ä¸­é—´marginï¼‰ */
    .content-container {
      position: absolute;
      top: 70px; /* æœç´¢æ åº•éƒ¨ä½ç½® */
      left: 0;
      width: 100%;
      height: calc(100% - 125px); /* é¡¶éƒ¨70px + åº•éƒ¨55px */
      overflow-y: auto;
      z-index: 980;
    }
    .content-page {
      width: 100%;
      height: 100%;
      display: none;
      padding-top: 10px; /* é¡¶éƒ¨è½»å¾®é—´è· */
    }
    .content-page.active {
      display: block;
    }
    /* ç©ºçŠ¶æ€æç¤ºï¼šè°ƒæ•´ä¸ºé¡¶éƒ¨å¯¹é½ï¼Œé¿å…å±…ä¸­ */
    .empty-tip {
      width: 100%;
      padding-top: 50px; /* é¡¶éƒ¨ç•™ç©ºï¼Œä¸å±…ä¸­ */
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      color: #999;
      font-size: 14px;
    }
    .empty-icon {
      font-size: 48px;
      margin-bottom: 10px;
      color: #eee;
    }
    /* æ¶ˆæ¯é¡¹æ ·å¼ */
    .msg-item {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      border-bottom: 1px solid #f5f5f5;
      cursor: pointer;
    }
    .msg-avatar {
      width: 45px;
      height: 45px;
      border-radius: 8px;
      background: #eee;
      overflow: hidden;
      margin-right: 12px;
    }
    .msg-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .msg-info {
      flex: 1;
    }
    .msg-name {
      font-size: 14px;
      color: #333;
      margin-bottom: 3px;
    }
    .msg-content {
      font-size: 12px;
      color: #999;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    /* è”ç³»äººé¡¹æ ·å¼ï¼šä»ä¸Šæ’åˆ—ï¼Œæ— ä¸­é—´é—´è· */
    .contact-item {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      border-bottom: 1px solid #f5f5f5;
      cursor: pointer;
    }
    .contact-avatar {
      width: 45px;
      height: 45px;
      border-radius: 8px;
      background: #eee;
      overflow: hidden;
      margin-right: 12px;
    }
    .contact-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .contact-name {
      font-size: 14px;
      color: #333;
    }
    /* åŠ¨æ€é¡¹æ ·å¼ */
    .moment-item {
      padding: 15px 20px;
      border-bottom: 1px solid #f5f5f5;
    }
    .moment-header {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .moment-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #eee;
      overflow: hidden;
      margin-right: 10px;
    }
    .moment-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .moment-name {
      font-size: 14px;
      color: #333;
      font-weight: 500;
    }
    .moment-content {
      font-size: 14px;
      color: #333;
      margin-bottom: 10px;
      line-height: 1.5;
    }
    .moment-media {
      width: 100%;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 10px;
    }
    .moment-media img, .moment-media video {
      width: 100%;
      height: auto;
    }
    /* åŠ¨æ€æ“ä½œåŒºï¼šå›¾æ ‡æ›¿ä»£æ–‡å­— */
    .moment-actions {
      display: flex;
      gap: 20px;
      font-size: 16px;
      color: #999;
    }
    .action-btn {
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 12px;
    }
    .action-icon {
      font-size: 16px;
    }
    /* éšè—åŸç”Ÿæ–‡ä»¶é€‰æ‹©å™¨ */
    #avatar-upload {
      display: none;
    }
  </style>
</head>
<body>
  <div class="phone-screen">
    <!-- è¿”å›é”®ï¼ˆè¿”å›æ¡Œé¢ï¼‰ -->
    <div class="back-btn" onclick="backToDesktop()"></div>
    <!-- ç”¨æˆ·å¤´åƒï¼šå·¦ä¸Šè§’ -->
    <div class="user-avatar" onclick="toggleAvatarMenu()">
      <img id="userAvatarImg" src="app.img/default-avatar.png" alt="ç”¨æˆ·å¤´åƒ">
    </div>
    <!-- å¤´åƒèœå• -->
    <div class="avatar-menu" id="avatarMenu">
      <div class="menu-item" onclick="showBigAvatar()">æŸ¥çœ‹å¤´åƒ</div>
      <div class="menu-item" onclick="selectAvatar()">æ›´æ¢å¤´åƒ</div>
      <input type="file" id="avatar-upload" accept="image/*" onchange="uploadAvatar(this)">
    </div>
    <!-- å¤´åƒæ”¾å¤§å¼¹çª— -->
    <div class="avatar-modal" id="avatarModal">
      <img id="bigAvatarImg" src="app.img/default-avatar.png" alt="æ”¾å¤§å¤´åƒ">
      <button class="close-modal" onclick="closeAvatarModal()">å…³é—­</button>
    </div>
    <!-- æœç´¢æ¡† -->
    <div class="search-bar" id="searchBar">
      <span>ğŸ”</span>
      <input type="text" id="searchInput" placeholder="æœç´¢" oninput="handleSearch()">
    </div>
    <!-- å³ä¸Šè§’åŠ å· -->
    <button class="add-btn" id="addBtn" onclick="toggleAddMenu()">+</button>
    <!-- åŠ å·èœå• -->
    <div class="add-menu" id="addMenu">
      <div class="menu-item" id="msgAddMenu" style="display:none;">æš‚æ— æ¶ˆæ¯ç›¸å…³åŠŸèƒ½</div>
      <div class="menu-item" id="contactAddMenu" style="display:none;" onclick="goToAddContact()">æ·»åŠ è”ç³»äºº</div>
      <div class="menu-item" id="groupAddMenu" style="display:none;" onclick="createGroupChat()">åˆ›å»ºç¾¤èŠ</div>
      <div class="menu-item" id="momentAddMenu" style="display:none;" onclick="goToAddMoment()">æ·»åŠ åŠ¨æ€</div>
      <div class="menu-item" id="generateMomentMenu" style="display:none;" onclick="goToGenerateMoment()">ç”Ÿæˆè”ç³»äººåŠ¨æ€</div>
    </div>
    <!-- åº•éƒ¨Tabæ  -->
    <div class="tab-bar">
      <div class="tab-item active" data-tab="msg" onclick="switchTab('msg')">
        <div class="tab-icon">ğŸ’¬</div>
        <div class="tab-text">æ¶ˆæ¯</div>
      </div>
      <div class="tab-item" data-tab="contact" onclick="switchTab('contact')">
        <div class="tab-icon">ğŸ‘¥</div>
        <div class="tab-text">è”ç³»äºº</div>
      </div>
      <div class="tab-item" data-tab="moment" onclick="switchTab('moment')">
        <div class="tab-icon">ğŸ“±</div>
        <div class="tab-text">åŠ¨æ€</div>
      </div>
    </div>
    <!-- å†…å®¹åŒº -->
    <div class="content-container">
      <!-- æ¶ˆæ¯é¡µ -->
      <div class="content-page active" id="msgPage">
        <div id="msgList" class="empty-tip">
          <div class="empty-icon">ğŸ’¬</div>
          <div>æ²¡æœ‰æ¶ˆæ¯</div>
        </div>
      </div>
      <!-- è”ç³»äººé¡µ -->
      <div class="content-page" id="contactPage">
        <div id="contactList" class="empty-tip">
          <div class="empty-icon">ğŸ‘¥</div>
          <div>æ²¡æœ‰è”ç³»äºº</div>
        </div>
      </div>
      <!-- åŠ¨æ€é¡µ -->
      <div class="content-page" id="momentPage">
        <div id="momentList" class="empty-tip">
          <div class="empty-icon">ğŸ“±</div>
          <div>æ²¡æœ‰åŠ¨æ€</div>
        </div>
      </div>
    </div>
  </div>
  <script>
    // æœ¬åœ°å­˜å‚¨Key
    const STORAGE_KEYS = {
      QQ: 'qqConfig',
      API: 'apiManagerConfigs',
      MUSIC: 'musicPlayerConfig',
      EMOJI: 'qqEmojiStorage',
      IMAGE: 'qqImageStorage' // æ–°å¢ï¼šå›¾ç‰‡æŒä¹…åŒ–å­˜å‚¨Key
    };
    // å…¨å±€çŠ¶æ€
    let qqConfig = {
      userAvatar: 'app.img/default-avatar.png',
      contacts: [],
      moments: [],
      emojiList: [],
      imageMap: {} // æ–°å¢ï¼šå›¾ç‰‡URLæ˜ å°„ï¼ˆæŒä¹…åŒ–å­˜å‚¨å›¾ç‰‡Base64ï¼‰
    };
    let activeTab = 'msg';

    // é¡µé¢åˆå§‹åŒ–ï¼šåŠ è½½æ‰€æœ‰æœ¬åœ°æ•°æ®ï¼ˆå«å›¾ç‰‡æŒä¹…åŒ–ï¼‰
    window.onload = initQQ();

    // 1. åˆå§‹åŒ–QQé…ç½®ï¼ˆä¿®å¤å›¾ç‰‡æœ¬åœ°ä¿å­˜ï¼‰
    function initQQ() {
      const savedQQ = localStorage.getItem(STORAGE_KEYS.QQ);
      if (savedQQ) {
        qqConfig = JSON.parse(savedQQ);
        // æ¢å¤ç”¨æˆ·å¤´åƒï¼ˆä»imageMapè¯»å–Base64ï¼‰
        const userAvatarBase64 = qqConfig.imageMap[qqConfig.userAvatar];
        if (userAvatarBase64) {
          qqConfig.userAvatar = userAvatarBase64;
        }
        // æ¢å¤è”ç³»äººå¤´åƒ/èƒŒæ™¯ï¼ˆä»imageMapè¯»å–Base64ï¼‰
        qqConfig.contacts.forEach(contact => {
          if (contact.avatar && qqConfig.imageMap[contact.avatar]) {
            contact.avatar = qqConfig.imageMap[contact.avatar];
          }
          if (contact.bg && qqConfig.imageMap[contact.bg]) {
            contact.bg = qqConfig.imageMap[contact.bg];
          }
        });
        // æ¢å¤åŠ¨æ€å›¾ç‰‡
        qqConfig.moments.forEach(moment => {
          if (moment.media?.url && qqConfig.imageMap[moment.media.url]) {
            moment.media.url = qqConfig.imageMap[moment.media.url];
          }
        });
        // æ¢å¤è¡¨æƒ…åŒ…
        qqConfig.emojiList.forEach(emoji => {
          if (emoji.url && qqConfig.imageMap[emoji.url]) {
            emoji.url = qqConfig.imageMap[emoji.url];
          }
        });
        // æ›´æ–°DOMæ˜¾ç¤º
        document.getElementById('userAvatarImg').src = qqConfig.userAvatar;
        document.getElementById('bigAvatarImg').src = qqConfig.userAvatar;
        localStorage.setItem(STORAGE_KEYS.EMOJI, JSON.stringify(qqConfig.emojiList));
      } else {
        qqConfig = {
          userAvatar: 'app.img/default-avatar.png',
          contacts: [],
          moments: [],
          emojiList: [],
          imageMap: {}
        };
        saveQQConfig();
      }
      // æ¸²æŸ“é¡µé¢
      renderMsgPage();
      renderContactPage();
      renderMomentPage();
      updateAddMenuByTab(activeTab);
    }

    // 2. ä¿å­˜QQé…ç½®ï¼ˆå«å›¾ç‰‡Base64æŒä¹…åŒ–ï¼‰
    function saveQQConfig() {
      localStorage.setItem(STORAGE_KEYS.QQ, JSON.stringify(qqConfig));
    }

    // 3. å›¾ç‰‡è½¬Base64ï¼ˆæ–°å¢ï¼šå®ç°å›¾ç‰‡æœ¬åœ°æŒä¹…åŒ–ï¼‰
    function imageToBase64(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.readAsDataURL(file);
      });
    }

    // 4. å¤´åƒä¸Šä¼ ï¼ˆä¿®å¤æœ¬åœ°ä¿å­˜ï¼‰
    async function uploadAvatar(input) {
      const file = input.files[0];
      if (!file) return;
      // è½¬Base64å¹¶æŒä¹…åŒ–
      const base64Url = await imageToBase64(file);
      const tempKey = `avatar_${Date.now()}`;
      qqConfig.imageMap[tempKey] = base64Url;
      qqConfig.userAvatar = base64Url;
      // æ›´æ–°DOM
      document.getElementById('userAvatarImg').src = base64Url;
      document.getElementById('bigAvatarImg').src = base64Url;
      saveQQConfig();
      input.value = '';
    }

    // 5. å…¶ä»–åŸæœ‰å‡½æ•°ï¼ˆä¿æŒä¸å˜ï¼Œæ–°å¢å‡½æ•°è§åç»­æ¨¡å—ï¼‰
    function toggleAvatarMenu() {
      const menu = document.getElementById('avatarMenu');
      menu.classList.toggle('active');
    }

    function showBigAvatar() {
      const modal = document.getElementById('avatarModal');
      modal.classList.add('active');
      toggleAvatarMenu();
    }

    function closeAvatarModal() {
      const modal = document.getElementById('avatarModal');
      modal.classList.remove('active');
    }

    function selectAvatar() {
      document.getElementById('avatar-upload').click();
      toggleAvatarMenu();
    }

    function switchTab(tabName) {
      document.querySelectorAll('.tab-item').forEach(item => item.classList.remove('active'));
      document.querySelector(`.tab-item[data-tab="${tabName}"]`).classList.add('active');
      document.querySelectorAll('.content-page').forEach(page => page.classList.remove('active'));
      document.getElementById(`${tabName}Page`).classList.add('active');
      const searchInput = document.getElementById('searchInput');
      switch (tabName) {
        case 'msg':
          searchInput.placeholder = 'æœç´¢èŠå¤©è®°å½•';
          break;
        case 'contact':
          searchInput.placeholder = 'æœç´¢è”ç³»äºº';
          break;
        case 'moment':
          searchInput.placeholder = 'æœç´¢åŠ¨æ€';
          break;
      }
      activeTab = tabName;
      updateAddMenuByTab(tabName);
      searchInput.value = '';
    }

    function updateAddMenuByTab(tabName) {
      document.getElementById('msgAddMenu').style.display = 'none';
      document.getElementById('contactAddMenu').style.display = 'none';
      document.getElementById('groupAddMenu').style.display = 'none';
      document.getElementById('momentAddMenu').style.display = 'none';
      document.getElementById('generateMomentMenu').style.display = 'none';
      switch (tabName) {
        case 'contact':
          document.getElementById('contactAddMenu').style.display = 'block';
          document.getElementById('groupAddMenu').style.display = 'block';
          break;
        case 'moment':
          document.getElementById('momentAddMenu').style.display = 'block';
          document.getElementById('generateMomentMenu').style.display = 'block';
          break;
        case 'msg':
          document.getElementById('msgAddMenu').style.display = 'block';
          break;
      }
    }

    function toggleAddMenu() {
      const addMenu = document.getElementById('addMenu');
      addMenu.classList.toggle('active');
    }

    function handleSearch() {
      const keyword = document.getElementById('searchInput').value.trim().toLowerCase();
      if (activeTab === 'msg') searchMsg(keyword);
      else if (activeTab === 'contact') searchContact(keyword);
      else if (activeTab === 'moment') searchMoment(keyword);
    }

    function searchMsg(keyword) {
      const msgList = document.getElementById('msgList');
      const filteredContacts = qqConfig.contacts.filter(contact => {
        if (!contact.chatLogs || contact.chatLogs.length === 0) return false;
        return contact.chatLogs.some(log => log.content.toLowerCase().includes(keyword)) || contact.name.toLowerCase().includes(keyword);
      });
      if (filteredContacts.length === 0) {
        msgList.innerHTML = `<div class="empty-tip"><div class="empty-icon">ğŸ”</div><div>æœªæ‰¾åˆ°ç›¸å…³æ¶ˆæ¯</div></div>`;
        return;
      }
      let html = '';
      filteredContacts.forEach(contact => {
        const lastLog = contact.chatLogs[contact.chatLogs.length - 1];
        html += `
          <div class="msg-item" onclick="goToChat(${contact.id})" oncontextmenu="showMsgMenu(event, ${contact.id})">
            <div class="msg-avatar"><img src="${contact.avatar || 'app.img/default-contact.png'}" alt="${contact.name}"></div>
            <div class="msg-info"><div class="msg-name">${contact.name}</div><div class="msg-content">${lastLog.content}</div></div>
          </div>
        `;
      });
      msgList.innerHTML = html;
    }

    function searchContact(keyword) {
      const contactList = document.getElementById('contactList');
      const filteredContacts = qqConfig.contacts.filter(contact => contact.name.toLowerCase().includes(keyword));
      if (filteredContacts.length === 0) {
        contactList.innerHTML = `<div class="empty-tip"><div class="empty-icon">ğŸ‘¥</div><div>æœªæ‰¾åˆ°ç›¸å…³è”ç³»äºº</div></div>`;
        return;
      }
      let html = '';
      filteredContacts.forEach(contact => {
        html += `
          <div class="contact-item" onclick="goToContactDetail(${contact.id})">
            <div class="contact-avatar"><img src="${contact.avatar || 'app.img/default-contact.png'}" alt="${contact.name}"></div>
            <div class="contact-name">${contact.name}</div>
          </div>
        `;
      });
      contactList.innerHTML = html;
    }

    function searchMoment(keyword) {
      const momentList = document.getElementById('momentList');
      const filteredMoments = qqConfig.moments.filter(moment => moment.content.toLowerCase().includes(keyword) || moment.authorName.toLowerCase().includes(keyword));
      if (filteredMoments.length === 0) {
        momentList.innerHTML = `<div class="empty-tip"><div class="empty-icon">ğŸ“±</div><div>æœªæ‰¾åˆ°ç›¸å…³åŠ¨æ€</div></div>`;
        return;
      }
      renderMomentList(filteredMoments);
    }

    // 6. åŠ¨æ€ç‚¹èµåŠŸèƒ½ï¼ˆä¿®å¤ï¼šå•æ¬¡ç‚¹èµåˆ‡æ¢ï¼‰
    function likeMoment(momentId) {
      const moment = qqConfig.moments.find(m => m.id === momentId);
      if (moment) {
        // è®°å½•ç”¨æˆ·ç‚¹èµçŠ¶æ€ï¼ˆåŸºäºlocalStorageï¼‰
        const likedMoments = JSON.parse(localStorage.getItem('likedMoments') || '[]');
        const isLiked = likedMoments.includes(momentId);
        if (isLiked) {
          // å–æ¶ˆç‚¹èµ
          moment.likeCount = Math.max(0, (moment.likeCount || 0) - 1);
          localStorage.setItem('likedMoments', JSON.stringify(likedMoments.filter(id => id !== momentId)));
        } else {
          // ç‚¹èµ
          moment.likeCount = (moment.likeCount || 0) + 1;
          likedMoments.push(momentId);
          localStorage.setItem('likedMoments', JSON.stringify(likedMoments));
        }
        saveQQConfig();
        renderMomentPage();
      }
    }

    // å…¶ä»–åŸæœ‰å‡½æ•°ï¼ˆrenderMsgPageã€renderContactPageç­‰ï¼‰ä¿æŒä¸å˜ï¼Œç¡®ä¿è°ƒç”¨saveQQConfig()æ—¶åŒ…å«imageMap
    function renderMsgPage() {
      const msgList = document.getElementById('msgList');
      const hasChatContacts = qqConfig.contacts.filter(contact => contact.chatLogs && contact.chatLogs.length > 0);
      if (hasChatContacts.length === 0) {
        msgList.innerHTML = `<div class="empty-tip"><div class="empty-icon">ğŸ’¬</div><div>æ²¡æœ‰æ¶ˆæ¯</div></div>`;
        return;
      }
      hasChatContacts.sort((a, b) => new Date(b.chatLogs[b.chatLogs.length - 1].time) - new Date(a.chatLogs[a.chatLogs.length - 1].time));
      let html = '';
      hasChatContacts.forEach(contact => {
        const lastLog = contact.chatLogs[contact.chatLogs.length - 1];
        html += `
          <div class="msg-item" onclick="goToChat(${contact.id})" oncontextmenu="showMsgMenu(event, ${contact.id})">
            <div class="msg-avatar"><img src="${contact.avatar || 'app.img/default-contact.png'}" alt="${contact.name}"></div>
            <div class="msg-info"><div class="msg-name">${contact.name}</div><div class="msg-content">${lastLog.content}</div></div>
          </div>
        `;
      });
      msgList.innerHTML = html;
    }

    function renderContactPage() {
      const contactList = document.getElementById('contactList');
      if (qqConfig.contacts.length === 0) {
        contactList.innerHTML = `<div class="empty-tip"><div class="empty-icon">ğŸ‘¥</div><div>æ²¡æœ‰è”ç³»äºº</div></div>`;
        return;
      }
      qqConfig.contacts.sort((a, b) => a.name.localeCompare(b.name));
      let html = '';
      qqConfig.contacts.forEach(contact => {
        html += `
          <div class="contact-item" onclick="goToContactDetail(${contact.id})">
            <div class="contact-avatar"><img src="${contact.avatar || 'app.img/default-contact.png'}" alt="${contact.name}"></div>
            <div class="contact-name">${contact.name}</div>
          </div>
        `;
      });
      contactList.innerHTML = html;
    }

    function renderMomentPage() {
      const momentList = document.getElementById('momentList');
      if (qqConfig.moments.length === 0) {
        momentList.innerHTML = `<div class="empty-tip"><div class="empty-icon">ğŸ“±</div><div>æ²¡æœ‰åŠ¨æ€</div></div>`;
        return;
      }
      const sortedMoments = [...qqConfig.moments].sort((a, b) => new Date(b.time) - new Date(a.time));
      renderMomentList(sortedMoments);
    }

    function renderMomentList(moments) {
      const momentList = document.getElementById('momentList');
      let html = '';
      moments.forEach(moment => {
        let mediaHtml = '';
        if (moment.media) {
          if (moment.media.type === 'image') {
            mediaHtml = `<div class="moment-media"><img src="${moment.media.url}" alt="åŠ¨æ€å›¾ç‰‡"></div>`;
          } else if (moment.media.type === 'video') {
            mediaHtml = `<div class="moment-media"><video controls src="${moment.media.url}"></video></div>`;
          }
        }
        let commentHtml = '';
        if (moment.comments && moment.comments.length > 0) {
          moment.comments.forEach(comment => {
            commentHtml += `<div style="padding:5px 0; font-size:12px; color:#666;"><span style="color:#ff69b4;">${comment.authorName}ï¼š</span>${comment.content}<span style="margin-left:10px; color:#999; cursor:pointer;" onclick="replyComment(${moment.id}, ${comment.id})">å›å¤</span></div>`;
          });
        }
        html += `
          <div class="moment-item" data-moment-id="${moment.id}">
            <div class="moment-header"><div class="moment-avatar"><img src="${moment.authorAvatar}" alt="${moment.authorName}"></div><div class="moment-name">${moment.authorName}</div></div>
            <div class="moment-content">${moment.content}</div>
            ${mediaHtml}
            <div class="moment-actions">
              <div class="action-btn" onclick="replyMoment(${moment.id})"><span class="action-icon">ğŸ’¬</span><span>è¯„è®º(${moment.comments?.length || 0})</span></div>
              <div class="action-btn" onclick="likeMoment(${moment.id})"><span class="action-icon">â¤ï¸</span><span>ç‚¹èµ(${moment.likeCount || 0})</span></div>
            </div>
            ${commentHtml}
            <div class="comment-input" style="margin-top:10px; display:none;"><input type="text" placeholder="è¾“å…¥è¯„è®º..." style="width:70%; padding:5px; border:1px solid #f5f5f5; border-radius:5px;"><button style="padding:5px 10px; background:#ff69b4; color:#fff; border:none; border-radius:5px; cursor:pointer;" onclick="sendComment(${moment.id})">å‘é€</button></div>
          </div>
        `;
      });
      momentList.innerHTML = html;
    }

    // å…¶ä½™å‡½æ•°ï¼ˆgoToAddContactã€goToChatç­‰ï¼‰ä¿æŒä¸å˜ï¼Œç¡®ä¿è°ƒç”¨saveQQConfig()
    function goToAddContact() {
      window.location.href = 'qq-add-contact.html';
    }

    function createGroupChat() {
      if (qqConfig.contacts.length < 2) {
        alert('è‡³å°‘éœ€è¦2ä¸ªè”ç³»äººæ‰èƒ½åˆ›å»ºç¾¤èŠï½');
        return;
      }
      alert('ç¾¤èŠåŠŸèƒ½å·²è§¦å‘');
    }

    function goToContactDetail(contactId) {
      localStorage.setItem('currentContactId', contactId);
      window.location.href = 'qq-contact-detail.html';
    }

    function goToChat(contactId) {
      localStorage.setItem('currentChatContactId', contactId);
      window.location.href = 'qq-chat.html';
    }

    function showMsgMenu(event, contactId) {
      event.preventDefault();
      if (confirm('æ˜¯å¦åˆ é™¤è¯¥èŠå¤©ï¼Ÿï¼ˆèŠå¤©æ•°æ®ä¸åˆ é™¤ï¼‰')) {
        renderMsgPage();
      }
    }

    function goToAddMoment() {
      window.location.href = 'qq-add-moment.html';
    }
    function goToGenerateMoment() {
      if (qqConfig.contacts.length === 0) {
        alert('æ²¡æœ‰è”ç³»äººï¼Œæ— æ³•ç”Ÿæˆè”ç³»äººåŠ¨æ€ï½');
        return;
      }
      localStorage.setItem('tempContactList', JSON.stringify(qqConfig.contacts));
      window.location.href = 'qq-generate-moment.html';
    }

    function replyMoment(momentId) {
      const momentItem = document.querySelector(`.moment-item[data-moment-id="${momentId}"]`);
      const commentInput = momentItem.querySelector('.comment-input');
      commentInput.style.display = 'flex';
      commentInput.querySelector('input').focus();
    }

    function replyComment(momentId, commentId) {
      alert(`å›å¤è¯„è®º ${commentId}`);
    }

    async function sendComment(momentId) {
      const momentItem = document.querySelector(`.moment-item[data-moment-id="${momentId}"]`);
      const input = momentItem.querySelector('.comment-input input');
      const content = input.value.trim();
      if (!content) return;

      const moment = qqConfig.moments.find(m => m.id === momentId);
      if (moment) {
        if (!moment.comments) moment.comments = [];
        moment.comments.push({
          id: Date.now(),
          authorName: 'æˆ‘',
          authorAvatar: qqConfig.userAvatar,
          content: content,
          time: new Date().toISOString()
        });
        saveQQConfig();
        renderMomentPage();
      }
      input.value = '';
      momentItem.querySelector('.comment-input').style.display = 'none';
    }

    function backToDesktop() {
      window.location.href = 'index.html';
    }
  </script>
</body>
</html>

   

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ç”Ÿæˆè”ç³»äººåŠ¨æ€ - å¯çˆ±QQ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "PingFang SC", "å¾®è½¯é›…é»‘", sans-serif;
    }
    body {
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #f5f5f5;
    }
    /* æ‰‹æœºå®¹å™¨ */
    .phone-screen {
      width: 375px;
      height: 812px;
      border: 1px solid #eee;
      border-radius: 40px;
      overflow: hidden;
      position: relative;
      background: #fff;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    /* è¿”å›é”® */
    .back-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      width: 36px;
      height: 36px;
      background: #f8dce8;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(255,182,193,0.3);
      z-index: 999;
    }
    .back-btn::after {
      content: '';
      width: 14px;
      height: 14px;
      border-top: 2px solid #ffabb8;
      border-left: 2px solid #ffabb8;
      transform: rotate(-45deg);
    }
    /* æ ‡é¢˜ */
    .page-title {
      position: absolute;
      top: 25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 18px;
      color: #333;
      font-weight: bold;
      z-index: 990;
    }
    /* å†…å®¹åŒº */
    .content-container {
      position: absolute;
      top: 80px;
      left: 0;
      width: 100%;
      height: calc(100% - 80px);
      padding: 20px;
      overflow-y: auto;
      z-index: 980;
    }
    /* è”ç³»äººåˆ—è¡¨ */
    .contact-list {
      width: 100%;
    }
    .contact-item {
      display: flex;
      align-items: center;
      padding: 15px 10px;
      border-bottom: 1px solid #f5f5f5;
      cursor: pointer;
    }
    .contact-item:hover {
      background: #f5f5f5;
    }
    .contact-avatar {
      width: 50px;
      height: 50px;
      border-radius: 8px;
      background: #eee;
      overflow: hidden;
      margin-right: 15px;
    }
    .contact-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .contact-info {
      flex: 1;
    }
    .contact-name {
      font-size: 16px;
      color: #333;
      margin-bottom: 3px;
    }
    .contact-setting {
      font-size: 12px;
      color: #999;
    }
    /* ç©ºè”ç³»äººæç¤º */
    .empty-contact {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: #999;
      font-size: 14px;
    }
    .empty-icon {
      font-size: 48px;
      margin-bottom: 10px;
      color: #eee;
    }
  </style>
</head>
<body>
  <div class="phone-screen">
    <!-- è¿”å›é”®ï¼ˆè¿”å›QQä¸»ç•Œé¢ï¼‰ -->
    <div class="back-btn" onclick="backToQQMain()"></div>
    <!-- æ ‡é¢˜ -->
    <div class="page-title">é€‰æ‹©è”ç³»äººç”ŸæˆåŠ¨æ€</div>
    <!-- å†…å®¹åŒº -->
    <div class="content-container">
      <div id="contactListContainer" class="contact-list">
        <!-- åŠ¨æ€æ¸²æŸ“è”ç³»äººåˆ—è¡¨ -->
      </div>
    </div>
  </div>

  <script>
    // æœ¬åœ°å­˜å‚¨Key
    const STORAGE_KEYS = {
      QQ: 'qqConfig'
    };
    // è”ç³»äººåˆ—è¡¨
    let contactList = [];

    // é¡µé¢åˆå§‹åŒ–ï¼šåŠ è½½è”ç³»äººåˆ—è¡¨
    window.onload = initPage();

    // 1. åˆå§‹åŒ–é¡µé¢
    function initPage() {
      // è¯»å–ä¸´æ—¶å­˜å‚¨çš„è”ç³»äººåˆ—è¡¨ï¼ˆä»QQä¸»ç•Œé¢ä¼ é€’ï¼‰
      const tempContacts = localStorage.getItem('tempContactList');
      if (tempContacts) {
        contactList = JSON.parse(tempContacts);
        // æ¸…é™¤ä¸´æ—¶å­˜å‚¨
        localStorage.removeItem('tempContactList');
      } else {
        // ç›´æ¥è¯»å–QQé…ç½®
        const savedQQ = localStorage.getItem(STORAGE_KEYS.QQ);
        if (savedQQ) {
          const qqConfig = JSON.parse(savedQQ);
          contactList = qqConfig.contacts;
        }
      }

      // æ¸²æŸ“è”ç³»äººåˆ—è¡¨
      renderContactList();
    }

    // 2. æ¸²æŸ“è”ç³»äººåˆ—è¡¨
    function renderContactList() {
      const container = document.getElementById('contactListContainer');
      
      if (contactList.length === 0) {
        container.innerHTML = `
          <div class="empty-contact">
            <div class="empty-icon">ğŸ‘¥</div>
            <div>æ²¡æœ‰è”ç³»äºº</div>
          </div>
        `;
        return;
      }

      // æ¸²æŸ“è”ç³»äºº
      let html = '';
      contactList.forEach(contact => {
        html += `
          <div class="contact-item" onclick="generateMoment(${contact.id}, '${contact.name}', '${contact.avatar || 'app.img/default-contact.png'}', '${contact.setting || ''}')">
            <div class="contact-avatar">
              <img src="${contact.avatar || 'app.img/default-contact.png'}" alt="${contact.name}">
            </div>
            <div class="contact-info">
              <div class="contact-name">${contact.name}</div>
              <div class="contact-setting">${contact.setting || 'æš‚æ— è®¾å®š'}</div>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // 3. ç”Ÿæˆè”ç³»äººåŠ¨æ€ï¼ˆåŸºäºè§’è‰²è®¾å®šå’ŒèŠå¤©è®°å½•ï¼‰
    function generateMoment(contactId, contactName, contactAvatar, contactSetting) {
      // è¯»å–QQé…ç½®ï¼Œè·å–è¯¥è”ç³»äººçš„èŠå¤©è®°å½•
      const savedQQ = localStorage.getItem(STORAGE_KEYS.QQ);
      if (!savedQQ) {
        alert('ç”Ÿæˆå¤±è´¥ï¼Œæœªæ‰¾åˆ°QQé…ç½®ï¼');
        backToQQMain();
        return;
      }

      const qqConfig = JSON.parse(savedQQ);
      const contact = qqConfig.contacts.find(c => c.id === contactId);
      const chatLogs = contact ? contact.chatLogs || [] : [];

      // åŸºäºè§’è‰²è®¾å®šå’ŒèŠå¤©è®°å½•ç”ŸæˆåŠ¨æ€å†…å®¹ï¼ˆç®€åŒ–é€»è¾‘ï¼‰
      let momentContent = '';
      // 1. ä¼˜å…ˆä½¿ç”¨è§’è‰²è®¾å®šç”Ÿæˆ
      if (contactSetting) {
        const settingThemes = {
          'æ´»æ³¼çš„å­¦ç”Ÿ': ['ä»Šå¤©åˆå’Œå¥½æœ‹å‹ä¸€èµ·å­¦ä¹ å•¦ï½', 'æ–°å­¦çš„çŸ¥è¯†ç‚¹å¥½æœ‰è¶£ï¼', 'æ”¾å­¦è·¯ä¸Šçœ‹åˆ°è¶…å¯çˆ±çš„å°çŒ«ï½'],
          'èŒåœºç™½é¢†': ['ä»Šå¤©å®Œæˆäº†é‡è¦é¡¹ç›®ï¼Œå¼€å¿ƒï¼', 'ä¸‹åˆèŒ¶çš„å’–å•¡è¶…å¥½å–ï½', 'åŠ ç­ingï¼ŒåŠ æ²¹ï¼'],
          'æ–‡è‰ºé’å¹´': ['ä»Šå¤©è¯»äº†ä¸€æœ¬è¶…æ²»æ„ˆçš„ä¹¦ï½', 'å…¬å›­çš„èŠ±å¼€äº†ï¼Œå¥½æ¼‚äº®ï½', 'å¬äº†ä¸€é¦–å–œæ¬¢çš„æ­Œï¼Œåˆ†äº«ç»™å¤§å®¶ï½'],
          'æ¸¸æˆçˆ±å¥½è€…': ['ä»Šå¤©æ¸¸æˆä¸Šåˆ†å•¦ï¼', 'æ–°å‡ºçš„æ¸¸æˆå¥½æœ‰æ„æ€ï½', 'ç»„é˜Ÿå¼€é»‘ï¼Œç¼ºä¸€ä¸ªé˜Ÿå‹ï¼']
        };
        // åŒ¹é…è®¾å®šå…³é”®è¯ï¼Œç”Ÿæˆå¯¹åº”å†…å®¹
        let matchedTheme = 'é€šç”¨';
        for (const theme in settingThemes) {
          if (contactSetting.includes(theme)) {
            matchedTheme = theme;
            break;
          }
        }
        // é€šç”¨å†…å®¹ï¼ˆæ— åŒ¹é…è®¾å®šæ—¶ï¼‰
        const defaultThemes = ['ä»Šå¤©å¤©æ°”çœŸå¥½ï½', 'åˆ†äº«ä¸€ä»¶å¼€å¿ƒçš„å°äº‹ï½', 'å¤§å®¶æœ€è¿‘è¿˜å¥½å—ï¼Ÿ'];
        const targetThemes = settingThemes[matchedTheme] || defaultThemes;
        momentContent = targetThemes[Math.floor(Math.random() * targetThemes.length)];
      } 
      // 2. æ— è®¾å®šæ—¶ï¼ŒåŸºäºæœ€æ–°èŠå¤©è®°å½•ç”Ÿæˆ
      else if (chatLogs.length > 0) {
        const lastLog = chatLogs[chatLogs.length - 1];
        momentContent = `ä»Šå¤©å’Œ${lastLog.isUser ? 'æœ‹å‹' : 'æˆ‘'}èŠåˆ°äº†${lastLog.content.slice(0, 8)}... å¾ˆæœ‰æ”¶è·ï½`;
      } 
      // 3. æ— è®¾å®šæ— èŠå¤©è®°å½•ï¼Œç”Ÿæˆé€šç”¨å†…å®¹
      else {
        momentContent = 'ä»Šå¤©ä¹Ÿæ˜¯å¼€å¿ƒçš„ä¸€å¤©ï½';
      }

      // åˆ›å»ºè”ç³»äººåŠ¨æ€
      const newMoment = {
        id: Date.now(),
        authorId: contactId, // æ ‡è®°ä¸ºè¯¥è”ç³»äººçš„åŠ¨æ€
        authorName: contactName,
        authorAvatar: contactAvatar,
        content: momentContent,
        media: Math.random() > 0.5 ? { // 50%æ¦‚ç‡æ·»åŠ å›¾ç‰‡å ä½ç¬¦
          type: 'image',
          url: 'app.img/default-moment-img.jpg' // é»˜è®¤åŠ¨æ€å›¾ç‰‡
        } : null,
        time: new Date().toISOString(),
        comments: []
      };

      // æ·»åŠ åˆ°åŠ¨æ€åˆ—è¡¨
      qqConfig.moments.push(newMoment);
      // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
      localStorage.setItem(STORAGE_KEYS.QQ, JSON.stringify(qqConfig));

      // æç¤ºå¹¶è¿”å›QQä¸»ç•Œé¢
      alert(`å·²ä¸º${contactName}ç”ŸæˆåŠ¨æ€ï¼š${momentContent}`);
      backToQQMain();
    }

    // 4. è¿”å›QQä¸»ç•Œé¢
    function backToQQMain() {
      window.location.href = 'qq-main.html';
    }
  </script>
</body>
</html>


<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>添加联系人 - 可爱QQ</title>
  <style>
    /* 原有样式保持不变 */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "PingFang SC", "微软雅黑", sans-serif;
    }
    body {
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #f5f5f5;
    }
    .phone-screen {
      width: 375px;
      height: 812px;
      border: 1px solid #eee;
      border-radius: 40px;
      overflow: hidden;
      position: relative;
      background: #fff;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    .back-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      width: 36px;
      height: 36px;
      background: #f8dce8;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(255,182,193,0.3);
      z-index: 999;
    }
    .back-btn::after {
      content: '';
      width: 14px;
      height: 14px;
      border-top: 2px solid #ffabb8;
      border-left: 2px solid #ffabb8;
      transform: rotate(-45deg);
    }
    .page-title {
      position: absolute;
      top: 25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 18px;
      color: #333;
      font-weight: bold;
      z-index: 990;
    }
    .content-container {
      position: absolute;
      top: 80px;
      left: 0;
      width: 100%;
      height: calc(100% - 80px);
      padding: 20px;
      overflow-y: auto;
      z-index: 980;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      color: #666;
    }
    .avatar-upload {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      background: #eee;
      margin-bottom: 10px;
      overflow: hidden;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #999;
      font-size: 24px;
    }
    .avatar-upload img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .form-input {
      width: 100%;
      padding: 10px;
      border: 1px solid #f5f5f5;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
    }
    .bg-preview {
      width: 100%;
      height: 100px;
      border-radius: 8px;
      background: #f0f8ff;
      margin-bottom: 10px;
      overflow: hidden;
    }
    .bg-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .form-select {
      width: 100%;
      padding: 10px;
      border: 1px solid #f5f5f5;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      background: #fff;
    }
    .submit-btn {
      width: 100%;
      padding: 12px;
      background: #ff69b4;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 20px;
    }
    #avatar-input, #bg-input {
      display: none;
    }
  </style>
</head>
<body>
  <div class="phone-screen">
    <div class="back-btn" onclick="backToQQMain()"></div>
    <div class="page-title">添加联系人</div>
    <div class="content-container">
      <form id="addContactForm">
        <!-- 联系人头像 -->
        <div class="form-group">
          <label class="form-label">联系人头像</label>
          <div class="avatar-upload" onclick="selectAvatar()">
            <img id="avatar-preview" src="app.img/default-contact.png" alt="头像预览">
          </div>
          <input type="file" id="avatar-input" accept="image/*" onchange="previewAvatar(this)">
        </div>
        <!-- 联系人名称 -->
        <div class="form-group">
          <label class="form-label">联系人名称</label>
          <input type="text" class="form-input" id="contact-name" placeholder="请输入联系人名称" required>
        </div>
        <!-- 背景选择 -->
        <div class="form-group">
          <label class="form-label">背景（详情页+聊天页共用）</label>
          <div class="bg-preview" onclick="selectBg()">
            <img id="bg-preview" src="app.img/default-bg.jpg" alt="背景预览">
          </div>
          <input type="file" id="bg-input" accept="image/*" onchange="previewBg(this)">
        </div>
        <!-- 联系人设定 -->
        <div class="form-group">
          <label class="form-label">联系人设定（角色描述）</label>
          <input type="text" class="form-input" id="contact-setting" placeholder="请输入联系人角色设定（如：活泼的学生）">
        </div>
        <!-- API选择 -->
        <div class="form-group">
          <label class="form-label">API选择</label>
          <select class="form-select" id="api-select">
            <option value="-1">请选择API（可选）</option>
          </select>
        </div>
        <!-- 提交按钮 -->
        <button type="button" class="submit-btn" onclick="addContact()">添加联系人</button>
      </form>
    </div>
  </div>
  <script>
    // 本地存储Key
    const STORAGE_KEYS = {
      QQ: 'qqConfig',
      API: 'apiManagerConfigs',
      IMAGE: 'qqImageStorage'
    };
    // 临时存储图片Base64
    let tempAvatarBase64 = 'app.img/default-contact.png';
    let tempBgBase64 = 'app.img/default-bg.jpg';

    // 页面初始化：加载API列表
    window.onload = initPage();

    function initPage() {
      renderApiSelect();
      // 初始化默认图片（转Base64防止丢失）
      convertDefaultImgToBase64();
    }

    // 1. 图片转Base64（核心：实现本地持久化）
    function imageToBase64(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.readAsDataURL(file);
      });
    }

    // 2. 转换默认图片为Base64（防止初始图片丢失）
    async function convertDefaultImgToBase64() {
      // 转换默认头像
      const avatarImg = new Image();
      avatarImg.crossOrigin = 'anonymous';
      avatarImg.src = 'app.img/default-contact.png';
      avatarImg.onload = async () => {
        const canvas = document.createElement('canvas');
        canvas.width = avatarImg.width;
        canvas.height = avatarImg.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(avatarImg, 0, 0);
        tempAvatarBase64 = canvas.toDataURL('image/png');
      };

      // 转换默认背景
      const bgImg = new Image();
      bgImg.crossOrigin = 'anonymous';
      bgImg.src = 'app.img/default-bg.jpg';
      bgImg.onload = async () => {
        const canvas = document.createElement('canvas');
        canvas.width = bgImg.width;
        canvas.height = bgImg.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(bgImg, 0, 0);
        tempBgBase64 = canvas.toDataURL('image/jpeg');
      };
    }

    // 3. 渲染API列表
    function renderApiSelect() {
      const apiSelect = document.getElementById('api-select');
      const savedApiList = localStorage.getItem(STORAGE_KEYS.API);
      if (!savedApiList) return;

      const apiList = JSON.parse(savedApiList);
      if (apiList.length === 0) return;

      apiList.forEach(api => {
        const option = document.createElement('option');
        option.value = api.apiKey;
        option.textContent = api.apiName;
        apiSelect.appendChild(option);
      });
    }

    // 4. 头像选择与预览（转Base64）
    function selectAvatar() {
      document.getElementById('avatar-input').click();
    }

    async function previewAvatar(input) {
      const file = input.files[0];
      if (!file) return;
      // 转Base64
      tempAvatarBase64 = await imageToBase64(file);
      document.getElementById('avatar-preview').src = tempAvatarBase64;
      input.value = '';
    }

    // 5. 背景选择与预览（转Base64）
    function selectBg() {
      document.getElementById('bg-input').click();
    }

    async function previewBg(input) {
      const file = input.files[0];
      if (!file) return;
      // 转Base64
      tempBgBase64 = await imageToBase64(file);
      document.getElementById('bg-preview').src = tempBgBase64;
      input.value = '';
    }

    // 6. 添加联系人（保存Base64到imageMap）
    async function addContact() {
      const contactName = document.getElementById('contact-name').value.trim();
      const contactSetting = document.getElementById('contact-setting').value.trim();
      const selectedApiId = document.getElementById('api-select').value;

      if (!contactName) {
        alert('请输入联系人名称！');
        return;
      }

      // 读取现有QQ配置
      const savedQQ = localStorage.getItem(STORAGE_KEYS.QQ);
      const qqConfig = savedQQ ? JSON.parse(savedQQ) : {
        userAvatar: 'app.img/default-avatar.png',
        contacts: [],
        moments: [],
        imageMap: {} // 存储图片Base64的映射表
      };

      // 生成唯一Key，避免图片URL冲突
      const avatarKey = `contact_avatar_${Date.now()}`;
      const bgKey = `contact_bg_${Date.now()}`;

      // 保存图片Base64到imageMap
      qqConfig.imageMap[avatarKey] = tempAvatarBase64;
      qqConfig.imageMap[bgKey] = tempBgBase64;

      // 创建新联系人（引用imageMap的Key）
      const newContact = {
        id: Date.now(),
        name: contactName,
        avatar: avatarKey, // 存储Key而非直接存储Base64
        bg: bgKey,
        setting: contactSetting,
        apiId: selectedApiId !== '-1' ? selectedApiId : null,
        chatLogs: [],
        isBlocked: false // 初始化拉黑状态
      };

      // 添加到联系人列表
      qqConfig.contacts.push(newContact);

      // 保存到本地存储
      localStorage.setItem(STORAGE_KEYS.QQ, JSON.stringify(qqConfig));

      // 提示并返回
      alert('联系人添加成功！');
      backToQQMain();
    }

    // 7. 返回QQ主界面
    function backToQQMain() {
      window.location.href = 'qq-main.html';
    }
  </script>
</body>
</html>

